define(["core/ajax","theme_bootstrapbase/bootstrap","jquery","jqueryui","core/url","core/log"],function(t,e,$,i,a,o){"use strict";o.debug("local_tag - Drag&drop AMD"),window.$=$;var l=M.str.local_tag.readydragdrop,r=null,n=null,s=null,d=null,c=null,u=null,g=null,b={sourcegroupid:null,sortablelist:{},dropablelist:{}},f={},p=function(){require(["local_tag/Xloader"],function(){n.sortable({items:"> li",cursor:"move",connectWith:".itemList",helper:function(t,e){o.debug($(this).attr("id")+" sortable - helper");var i=$(e).clone(),a=$(e).siblings(".selected").not(".ui-sortable-placeholder");return a.length&&a.clone().appendTo(i),i.appendTo("body").show()},create:function(){$(this).addClass("dd-initialized"),$("#user-notifications").find(".alert").append(" <span>"+l+"</span>")},start:function(t,e){o.debug($(this).attr("id")+" sortable - start"),y($(this).attr("id"));var i=e.item.siblings(".selected").not(".ui-sortable-placeholder");i.length&&(i.clone().appendTo(e.item),i.remove())},stop:function(t,e){o.debug($(this).attr("id")+" sortable - stop"),e.item.after(e.item.find("li")),k($(this).attr("id"))},update:function(){f="",$(this).find(".selected").removeClass("selected"),$(this).find(".item").each(function(t,e){var i=$(e),a=i.attr("id");void 0!==a&&(f+=" "+w(a))}),f=f.trim(),o.debug($(this).attr("id")+" sortable - update"),C($(this).attr("id"),f)}}).disableSelection(),s.sortable({items:"> li",cursor:"move",connectWith:".itemList",helper:function(t,e){o.debug($(this).attr("id")+" sortable - helper");var i=$(e).clone(),a=$(e).siblings(".selected").not(".ui-sortable-placeholder");return a.length&&a.clone().appendTo(i),i.appendTo("body").show()},create:function(){$(this).addClass("dd-initialized")},start:function(t,e){o.debug($(this).attr("id")+" sortable - start"),y($(this).attr("id"));var i=e.item.siblings(".selected").not(".ui-sortable-placeholder");i.length&&(i.clone().appendTo(e.item),i.remove())},stop:function(t,e){o.debug($(this).attr("id")+" sortable - stop"),e.item.after(e.item.find("li")),k($(this).attr("id"))},update:function(){f="",$(this).find(".selected").removeClass("selected"),$(this).find(".item").each(function(t,e){var i=$(e).attr("id");void 0!==i&&(f+=" "+w(i))}),f=f.trim(),o.debug($(this).attr("id")+" sortable - update"),C($(this).attr("id"),f)}}).disableSelection(),s.sortable("disable"),$(".accordion-toggle").droppable({hoverClass:"mx-content-hover",drop:function(t,e){var i=$(t.target),a=i.attr("href"),l=$(a),r=e.draggable.clone(),n=r.find("li").detach(),s=l.find(".itemList").eq(0);o.debug(s.attr("id")+" droppable - drop"),r.removeClass("ui-sortable-helper").removeClass("selected").attr("style",""),n.removeClass("ui-sortable-helper").removeClass("selected").attr("style",""),s.append(r),r.after(n),setTimeout(function(){var t=e.draggable.parent();e.draggable.remove(),n.each(function(){var e=$(this).attr("id");t.find("#"+e).remove()})},0),l.hasClass("in")||i.trigger("click"),f="",s.find(".item").each(function(t,e){var i=$(e).attr("id");void 0!==i&&(f+=" "+w(i))}),f=f.trim(),_(s.attr("id"),f)}}),$("#dd-lists").on("shown",".accordion-body",function(t){$(t.target).find(".itemList").sortable("enable")}).on("hidden",".accordion-body",function(t){$(t.target).find(".itemList").sortable("disable")})})},h=function(){var t=g.val();o.debug("»"+t+"«"),n.find(".hidden").removeClass("hidden"),void 0!==t&&""!==t&&n.find('li:not(:contains("'+t+'"))').addClass("hidden")},m=function(){var t=c.val();""!==t&&v(t),c.val("")},v=function(e){$.when(t.call([{methodname:"local_tag_add_course_tags",args:{taglist:e}}])[0]).then(function(t){var e=JSON.parse(t.tagarray);$.each(e,function(t,e){0===r.find("#"+e.id).length&&n.append('<li id="tagid-'+e.id+'" class="item ui-sortable ui-sortable-handle"><img class="smallicon" src="'+a.imageUrl("i/move_2d","core")+'"> '+e.name+"</li>")})})},y=function(t){b.sourcegroupid=t,b.sortablelist={},b.dropablelist={}},C=function(t,e){t!==b.sourcegroupid&&(b.sortablelist[t]=e)},_=function(t,e){b.dropablelist[t]=e},k=function(t){o.debug(t+" ddOnStop"),o.debug(b);var e="",i="";if($.isEmptyObject(b.dropablelist)){if(!$.isEmptyObject(b.sortablelist))for(e in b.sortablelist)if(b.sortablelist.hasOwnProperty(e)){i=b.sortablelist[e];break}}else for(e in b.dropablelist)if(b.dropablelist.hasOwnProperty(e)){i=b.dropablelist[e];break}i.length&&O(w(e),i)},w=function(t){return void 0!==t&&t.indexOf("-")!==!1?t.split("-")[1]:(o.debug("getIntFromID missing »-« for: "+t),-1)},O=function(e,i){t.call([{methodname:"local_tag_group_tags",args:{groupid:e,taglist:i},done:function(t){o.debug("local_tag_group_tags response:"),o.debug(t.result)},fail:function(t){o.debug(t),window.location.reload(!0)}}])};return{init:function(){r=$("#dd-lists"),n=$("#draggableItemList-0"),s=$(".group-list"),d=$("#add-tag"),c=$("#add-field"),u=$("#filter-tag"),g=$("#filter-field"),f={},o.debug("local_tag - Drag&drop init"),n.on("click","li",function(){$(this).toggleClass("selected")}),s.on("click","li",function(){$(this).toggleClass("selected")}),p(),u.on("click",h),g.keyup(function(t){13===t.keyCode&&h()}),d.on("click",m),c.keyup(function(t){13===t.keyCode&&m()})}}});