define(["core/ajax","local_usertours/bootstrap-tour","jquery","core/templates","core/str"],function(a,b,c,d,e){var f={tourId:null,currentTour:null,context:null,init:function(a,b,d){f.tourId=a,f.context=d,"undefined"==typeof b&&(b=!0),b&&f.fetchTour(a),f.addResetLink(),c("body").on("click",'[data-action="local_usertours/resetpagetour"]',function(a){a.preventDefault(),f.resetTourState(f.tourId)})},fetchTour:function(b){c.when(a.call([{methodname:"local_usertours_fetch_tour",args:{tourid:b,context:f.context}}])[0],d.render("local_usertours/tourstep",{})).then(function(a,c){f.startBootstrapTour(b,c[0],a.tourConfig)})},addResetLink:function(){e.get_string("resettouronpage","local_usertours").done(function(a){c("footer, .logininfo").last().append('<div class="usertour"><a href="#" data-action="local_usertours/resetpagetour">'+a+"</a></div>")})},startBootstrapTour:function(a,c,d){f.currentTour&&(d.onEnd=null,f.currentTour.end()),d.onEnd=f.markTourComplete,d.template=c,f.currentTour=new b(d),f.currentTour.init(!0),f.currentTour.start(!0)},markTourComplete:function(){a.call([{methodname:"local_usertours_complete_tour",args:{tourid:f.tourId}}])},resetTourState:function(b){a.call([{methodname:"local_usertours_reset_tour",args:{path:window.location.href,tourid:b},done:function(a){a.startTour&&f.fetchTour(a.startTour)}}])}};return{init:f.init,resetTourState:f.resetTourState}});