define(["jquery","core/notification","core/log","core/ajax","core/templates","theme_bootstrapbase/bootstrap"],function($,e,t,a,n){"use strict";t.debug("AMD module loaded.");var o=[],r=[],d=null,i=null,c=null,s=null,l=null,u=null,f="hide-item",m={type:null,group:null,name:null,pretext:null,posttext:null,remove:0},h=function(e){var t=e.tags.groups,a;t.length&&(t.forEach(function(e){a=$.grep(e.shown,function(e){return 1===e.checked}),a.length&&(o=$.merge(o,a))}),p({selectedCourseTags:o}))},p=function(e){n.render("local_playground/course_search_selected_tags",e).done(function(e){s.append(e),l=s.find(".selected-tags")})},g=function(e){n.render("local_playground/course_search_region_search",e).done(function(e){c.after(e),v()})},y=function(e){n.render("local_playground/course_search_results",e).done(function(e){u.append(e),j()})},v=function(){require(["local_playground/Xloader"],function(){$("#date-from").datepicker({format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){_(e)}),$("#date-to").datepicker({format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){_(e)})})},_=function(e){var t=$(e.target),a=t.parents(".date"),o=e.format("yyyymmdd"),r=e.format("dd.mm.yyyy"),d=null,i=$.extend({},m,{type:a.data("type"),group:a.data("group"),name:a.data("name"),posttext:" "+r});t.siblings('input[type="hidden"]').eq(0).val(o),d=s.find("button").filter('[data-name="'+a.data("name")+'"]').parent("li").remove(),""===r?i.remove=1:n.render("local_playground/course_search_selected_tags_item",i).done(function(e){l.append(e)}),D(),j()},x=function(){var e=$(this),t=e.parent(),a=e.is(":checked"),o=null,r=$.extend({},m,{type:t.data("type"),group:t.data("group"),name:t.data("name")});a?n.render("local_playground/course_search_selected_tags_item",r).done(function(e){l.append(e)}):(o=s.find("button").filter('[data-name="'+e.parent().data("name")+'"]').parent("li").remove(),r.remove=1),"course"===t.data("type")&&D(),j()},b=function(){var e=$(this);"searchquery"===e.data("group")?i.find(".search-query").val(""):"date-from"===e.data("group")?($("#date-from").datepicker("update",""),$("#date-from-eurodate").val("")):"date-to"===e.data("group")?($("#date-to").datepicker("update",""),$("#date-to-eurodate").val("")):d.find("label").filter('[data-name="'+e.data("name")+'"]').find("input").prop("checked",!1),e.remove(),"course"===e.data("type")?D():"display"===e.data("type")&&j()},C=function(e){var t=$(this),a,o;e.preventDefault(),a=t.find(".search-query").val(),o=$.extend({},m,{type:"course",group:"searchquery",name:a,pretext:"Search text: "}),s.find("li").has('[data-group="searchquery"]').remove(),""!==a&&n.render("local_playground/course_search_selected_tags_item",o).done(function(e){l.append(e)}),D()},k=function(){return i.find("#course-search").val().toLowerCase()},q=function(){var e,t=[];return e=i.find("label").has(":checked"),e.each(function(){var e=$(this);"course"===e.data("type")&&t.push(e.data("group")+"-"+e.data("name"))}),t},O=function(){var e={from:null,to:null,datesset:!1},t;return t=$("#date-from-eurodate").val(),""!==t&&(e.from=t,e.datesset=!0),t=$("#date-to-eurodate").val(),""!==t&&(e.to=t,e.datesset=!0),e},w=function(){var e,t=[];return e=i.find("label").has(":checked"),e.each(function(){var e=$(this);"display"===e.data("type")&&t.push(e.data("group"))}),t},j=function(){var e=null,t=null,a=w(),n=!0,o="name",r=function(e,t){return n?$(t).data(o)<$(e).data(o)?1:-1:$(t).data(o)>$(e).data(o)?1:-1};a.indexOf("tags")!==-1?u.find(".course-list").removeClass(" tags-hidden"):u.find(".course-list").addClass(" tags-hidden"),a.indexOf("sortdesc")!==-1&&(n=!1),a.indexOf("date")!==-1&&(o="date"),e=u.find("#tabcards").find(".course-cards").eq(0),e.html(e.children(".course-card-item").sort(r)),e=u.find("#tablist").find(".course-list").find("tbody").eq(0),e.html(e.children(".course-list-item").sort(r)),t=u.find("#tablist").find(".course-list"),t.find("tr:not(.hide-item)").each(function(e){e%2?$(this).removeClass("odd"):$(this).addClass("odd")})},D=function(){var e=q(),t=k(),a=O(),n=""!==t,o=[],d,i,c,s,l,u;for(d=n?e.length+1:e.length,d+=a.datesset?1:0,c=0,s=r.length;c<s;c++){for(i=0,n&&r[c].textcollection.indexOf(t)!==-1&&i++,l=0,u=e.length;l<u;l++)r[c].tagcollection.indexOf(e[l])!==-1&&i++;null!==a.from&&null!==a.to?r[c].sortdate>=a.from&&r[c].sortdate<=a.to&&i++:null!==a.from?r[c].sortdate>=a.from&&i++:null!==a.to&&r[c].sortdate<=a.to&&i++,i===d&&o.push(r[c].id)}!o.length&&e.length&&o.push(-1),E(o)},E=function(e){var t=u.find(".course-cards"),a=u.find(".course-list");e.length?e[0]===-1?r.forEach(function(e){t.find("#coursecarditem-"+e.id).addClass("hide-item"),a.find("#courselistitem-"+e.id).addClass("hide-item")}):r.forEach(function(n){e.indexOf(n.id)!==-1?(t.find("#coursecarditem-"+n.id).removeClass("hide-item"),a.find("#courselistitem-"+n.id).removeClass("hide-item")):(t.find("#coursecarditem-"+n.id).addClass("hide-item"),a.find("#courselistitem-"+n.id).addClass("hide-item"))}):r.forEach(function(e){t.find("#coursecarditem-"+e.id).removeClass("hide-item"),a.find("#courselistitem-"+e.id).removeClass("hide-item")})},S=function(e){var t=[],a=[],n=[];return $.each(e,function(e,o){t=[],a=[],n.push(o.id),$.each(o.tags,function(e,n){a.push(n.group+"-"+n.name),t.push(n.name)}),o.tagcollection=a,o.textcollection=t.join(","),o.textcollection+=" "+o.name+" "+o.summary,o.textcollection=o.textcollection.toLowerCase()}),e.courseids=n,e};return{init:function(){t.debug("AMD module init."),d=$("#search-area"),i=$("#course-search-form"),s=$("#tag-area"),u=$("#result-area"),c=d.find(".form-search"),$.getJSON("./course_search.json",function(e){t.debug(e),h(e),g(e)}).fail(e.exception),$.getJSON("./courses.json",function(e){t.debug(e),r=S(e.courses),e.baseurl=M.cfg.wwwroot,y(e)}).fail(e.exception),d.on("click",'[type="checkbox"]',x),s.on("click","button",b),i.on("submit",C)}}});