define(["jquery","core/notification","core/log","core/ajax","core/templates","local_playground/cookie","theme_bootstrapbase/bootstrap"],function($,e,t,a,n,o){"use strict";window.$=$,t.debug("AMD module loaded.");var r="name",d=!0,i=!1,s=!1,l=!1,c=[],u=[],f=null,p=null,h=null,g=null,m=null,y=null,v=null,_=null,b=!1,x="hide-item",C="preselectedtags",k="433,430,431,16,39,108,196,268,352|449,452,450,453|458,459|460,462,463",q={id:0,type:null,group:null,name:null},w={id:0,type:null,group:null,name:null,sort:null,pretext:null,posttext:null,remove:0},O=function(e){var t=e.tags.groups,a;t.length&&(t.forEach(function(e){a=$.grep(e.shown,function(e){return 1===e.checked}),a.length&&(c=$.merge(c,a))}),E({selectedCourseTags:c}))},E=function(e){n.render("local_playground/course_search_selected_tags",e).done(function(e){y.append(e),v=y.find(".selected-tags")})},j=function(e){n.render("local_playground/course_search_region_search",e).done(function(e){m.after(e),l=!0,N(),J()})},D=function(e){n.render("local_playground/course_search_result_area",e).done(function(e){h.append(e),K()})},S=function(e){n.render("local_playground/course_search_tag_preselect_area",e).done(function(e){g.append(e),b=!0,J()})},J=function(){if(!s&&b&&l){var e=o.read("preselectedtags"),t=[],a=[],n=null;null!==e&&(t=e.split("|"),t.forEach(function(e){a.push(e.split(","))}),console.log(a),n=f.find(".tag-group"),n.length&&n.each(function(e){var t=$(this),n=null,o={};a[e].forEach(function(e){n=g.find('[data-id="'+e+'"]'),n.length&&(n.prop("checked",!0),o=$.extend({},q,{id:n.data("id"),type:n.data("type"),group:n.data("group"),name:n.data("name")}),L(t,o))})})),s=!0}},L=function(e,t){n.render("local_playground/course_search_region_search_groups_item",t).done(function(t){e.append(t)})},N=function(){require(["local_playground/Xloader"],function(){$("#date-from").datepicker({format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){A(e)}),$("#date-to").datepicker({format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){A(e)})})},A=function(e){var t=$(e.target),a=t.parents(".date"),o=e.format("yyyymmdd"),r=e.format("dd.mm.yyyy"),d=null,i=$.extend({},w,{type:a.data("type"),group:a.data("group"),name:a.data("name"),posttext:" "+r});t.siblings('input[type="hidden"]').eq(0).val(o),d=y.find("button").filter('[data-name="'+a.data("name")+'"]').parent("li").remove(),""===r?i.remove=1:n.render("local_playground/course_search_selected_tags_item",i).done(function(e){v.append(e)}),Q(),K()},B=function(){var e=$(this),t=e.parent(),a=e.is(":checked"),o=null,r=$.extend({},w,{id:t.data("id"),type:t.data("type"),group:t.data("group"),name:t.data("name")});a?"sort"===e.parent().data("group")?(o=y.find("button").filter('[data-group="sort"]').parent("li").remove(),r.sort=t.data("sort"),r.name="Sort by "+r.sort,n.render("local_playground/course_search_selected_tags_item",r).done(function(e){v.append(e)})):n.render("local_playground/course_search_selected_tags_item",r).done(function(e){v.append(e)}):(o=y.find("button").filter('[data-name="'+e.parent().data("name")+'"]').parent("li").remove(),r.remove=1),"course"===t.data("type")&&Q(),K()},H=function(){var e=$(this),t=e.is(":checked"),a=null,n=null,o="",r={};t?(o=e.data("group"),"municipality"!==o&&"region"!==o||(o="provider"),n=p.find("."+o),r=$.extend({},q,{id:e.data("id"),type:e.data("type"),group:e.data("group"),name:e.data("name")}),console.log(o,n,r),L(n,r)):p.find('[data-id="'+e.data("id")+'"]').remove()},W=function(){var e=$(this),t=e.find("option:selected").eq(0),a=e.siblings(".hidden").eq(0),n="";n=t.val().toLowerCase(),r!==n&&(r=n,a.data("sort",n),a.find("input").trigger("change"))},P=function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target),a=f.find("#select-sort"),n=a.find("option"),o=a.siblings(".hidden").eq(0),i="";i=t.data("sort"),r===i?(d=!d,f.find('[data-group="sortdesc"]').find("input").click()):r=i,n.find(":selected").prop("selected",!1),n.filter(function(){return $(this).val()===i}).prop("selected",!0),o.data("sort",i),o.find("input").trigger("change")},T=function(){var e=$(this);"searchquery"===e.data("group")?p.find(".search-query").val(""):"date-from"===e.data("group")?($("#date-from").datepicker("update",""),$("#date-from-eurodate").val("")):"date-to"===e.data("group")?($("#date-to").datepicker("update",""),$("#date-to-eurodate").val("")):f.find("label").filter('[data-name="'+e.data("name")+'"]').find("input").prop("checked",!1),e.remove(),"course"===e.data("type")?Q():"display"===e.data("type")&&K()},X=function(e){var t=$(this),a,o;e.preventDefault(),a=t.find(".search-query").val(),o=$.extend({},w,{type:"course",group:"searchquery",name:a,pretext:"Search text: "}),y.find("li").has('[data-group="searchquery"]').remove(),""!==a&&n.render("local_playground/course_search_selected_tags_item",o).done(function(e){v.append(e)}),Q()},z=function(){return p.find("#course-search").val().toLowerCase()},F=function(){var e,t=[];return e=p.find("label").has(":checked"),e.each(function(){var e=$(this);"course"===e.data("type")&&t.push(e.data("group")+"-"+e.data("name"))}),t},G=function(){var e={from:null,to:null,datesset:!1},t;return t=$("#date-from-eurodate").val(),""!==t&&(e.from=t,e.datesset=!0),t=$("#date-to-eurodate").val(),""!==t&&(e.to=t,e.datesset=!0),e},I=function(){var e,t=[];return e=p.find("label").has(":checked"),e.each(function(){var e=$(this);"display"===e.data("type")&&("sort"===e.data("group")?t.push("sort-"+e.data("sort")):t.push(e.data("group")))}),t},K=function(){var e=null,t=null,a=I(),n="name",o=null,r=function(e,t){return d?$(t).data(n)<$(e).data(n)?1:-1:$(t).data(n)>$(e).data(n)?1:-1};-1!==a.indexOf("tags")?h.find(".course-list").removeClass("tags-hidden"):h.find(".course-list").addClass("tags-hidden"),d=-1===a.indexOf("sortdesc"),a.forEach(function(e){-1!==e.indexOf("sort-")&&(n=e.replace("sort-",""))}),h.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),h.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc"),o=h.find(".course-list-col-titles").find('[data-sort="'+n+'"]'),d?o.addClass("sortasc"):o.addClass("sortdesc"),e=h.find("#tabcards").find(".course-cards").eq(0),e.html(e.children(".course-card-item").sort(r)),e=h.find("#tablist").find(".course-list").find("tbody").eq(0),e.html(e.children(".course-list-item").sort(r)),t=h.find("#tablist").find(".course-list"),t.find("tr:not(.hide-item)").each(function(e){e%2?$(this).removeClass("odd"):$(this).addClass("odd")})},Q=function(){var e=F(),t=z(),a=G(),n=""!==t,o=[],r,d,i,s,l,c;for(r=n?e.length+1:e.length,r+=a.datesset?1:0,i=0,s=u.length;i<s;i++){for(d=0,n&&-1!==u[i].textcollection.indexOf(t)&&d++,l=0,c=e.length;l<c;l++)-1!==u[i].tagcollection.indexOf(e[l])&&d++;null!==a.from&&null!==a.to?u[i].sortdate>=a.from&&u[i].sortdate<=a.to&&d++:null!==a.from?u[i].sortdate>=a.from&&d++:null!==a.to&&u[i].sortdate<=a.to&&d++,d===r&&o.push(u[i].id)}!o.length&&e.length&&o.push(-1),R(o)},R=function(e){var t=h.find(".course-cards"),a=h.find(".course-list");e.length?-1===e[0]?u.forEach(function(e){t.find("#coursecarditem-"+e.id).addClass("hide-item"),a.find("#courselistitem-"+e.id).addClass("hide-item")}):u.forEach(function(n){-1!==e.indexOf(n.id)?(t.find("#coursecarditem-"+n.id).removeClass("hide-item"),a.find("#courselistitem-"+n.id).removeClass("hide-item")):(t.find("#coursecarditem-"+n.id).addClass("hide-item"),a.find("#courselistitem-"+n.id).addClass("hide-item"))}):u.forEach(function(e){t.find("#coursecarditem-"+e.id).removeClass("hide-item"),a.find("#courselistitem-"+e.id).removeClass("hide-item")})},U=function(){var e="",t=null,a,n;i&&(t=f.find(".tag-group"),a=t.length-1,t.length&&t.each(function(t){var o=$(this),r=null;r=o.find(".checkbox"),n=r.length-1,r.length&&r.each(function(t){e+=$(this).data("id"),t<n&&(e+=",")}),t<a&&(e+="|")}),console.log(e),o.create("preselectedtags",e,14)),i=!i,h.toggleClass("hidden"),g.toggleClass("hidden")},V=function(e){var t=[],a=[],n=[];return $.each(e,function(e,o){t=[],a=[],n.push(o.id),$.each(o.tags,function(e,n){a.push(n.group+"-"+n.name),t.push(n.name)}),o.tagcollection=a,o.textcollection=t.join(","),o.textcollection+=" "+o.name+" "+o.summary,o.textcollection=o.textcollection.toLowerCase()}),e.courseids=n,e};return{init:function(){t.debug("AMD module init."),null===o.read("preselectedtags")&&o.create("preselectedtags","433,430,431,16,39,108,196,268,352|449,452,450,453|458,459|460,462,463"),f=$("#search-area"),p=$("#course-search-form"),h=$("#result-area"),g=$("#tag-preselect-area"),y=$("#tag-area"),m=f.find(".form-search"),_=f.find("#switch-display"),$.getJSON("./course_search.json",function(e){t.debug(e),O(e),j(e)}).fail(e.exception),$.getJSON("./courses.json",function(e){t.debug(e),u=V(e.courses),e.baseurl=M.cfg.wwwroot,D(e)}).fail(e.exception),$.getJSON("./tags.json",function(e){t.debug(e),S(e)}).fail(e.exception),f.on("change",'[type="checkbox"]',B),f.on("change","select",W),h.on("click","th.coltitle",P),y.on("click","button",T),g.on("change",'[type="checkbox"]',H),p.on("submit",X),_.on("click",U)}}});