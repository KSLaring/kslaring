define(["jquery","core/notification","core/log","core/ajax","core/templates","theme_bootstrapbase/bootstrap","local_course_search/ld_loader","local_course_search/viewstate","local_course_search/is_loader","local_course_search/dp_loader"],function($,e,t,a,s,n,o,i,r){"use strict";if(window.$=$,t.debug("AMD module loaded."),!$("#header").hasClass("not-loggedin")){var d=!1,c="name",l=!0,u=!1,f=0,h=null,g=null,p={},m=[],y=[],v=[],_=12,b=6,C=30,w=15,x=!1,D=!1,k=[],O=[],S=0,T=null,q=null,I=null,j=null,E=null,P=null,F=null,J=null,N=null,V=null,L=null,B=null,A=null,H=null,W=null,z=null,G=null,K=null,Q=null,R=null,U=null,X=null,Y=!1,Z="hide-item",ee={id:0,type:null,group:null,name:null},te={id:0,type:null,group:null,name:null,sort:null,pretext:null,posttext:null,remove:0},ae={name:"sortorder",date:"sortdate",availseats:"availnumber",deadline:"deadline",municipality:"municipality",location:"location"},se={name:"course_name",date:"course_date",availseats:"course_seats",deadline:"course_deadline",municipality:"course_municipality",location:"course_location"},ne={view:0,text:1,tags:2,date:3,display:4},oe=function(e,t){s.render("local_course_search/course_search_region_search_groups_item",t).done(function(t){e.append(t)})},ie=function(e){"0"===i.getView()?he(12):pe(30)},re=function(e){x=!0,he(),T=new r(H.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("cardsInfScroll init")}}),le(!0)},de=function(e){D=!0,pe(),q=new r(W.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("listInfScroll init")}}),ue(!0)},ce=function(e){s.render("local_course_search/course_search_tag_preselect_area",e).done(function(e){G.html(e),Y=!0,Ae()})},le=function(e){T&&(e?T.on("scrollThreshold",fe):T.off("scrollThreshold",fe))},ue=function(e){q&&(e?q.on("scrollThreshold",ge):q.off("scrollThreshold",ge))},fe=function(){if(!k.length)return t.debug("card all shown"),void le(!1);t.debug("card more courses"),he()},he=function(e){if(1){var t=void 0===e?6:e,a={courses:[]},n=k.splice(0,t);a.courses=n.map(function(e){return p[e]}),a.courses.length&&s.render("local_course_search/course_search_course_card_set",a).done(function(e){H.append(e)})}},ge=function(){if(!O.length)return t.debug("list all shown"),void ue(!1);t.debug("list more courses"),pe()},pe=function(e){if(1){var t=void 0===e?15:e,a={courses:[]},n=O.splice(0,t);a.courses=n.map(function(e){return p[e]}),a.courses.length&&s.render("local_course_search/course_search_course_list_set",a).done(function(e){W.children("tbody").append(e)})}},me=function(e){var t=$(e.target).attr("href");"#tabcards"===t?(i.setView("0"),We(),H.children("li").length||he(12)):"#tablist"===t&&(i.setView("1"),We(),W.children("tbody").children("tr").length||pe(30))},ye=function(){var e="",t=[],a=null,s,n;u?(X.text(X.data("changetoselection")),L.find('[href="#tablist"]').hasClass("active")&&N.find(".display").find('[data-group="tags"]').removeClass("hidden"),a=J.find(".tag-group"),s=a.length-1,a.length&&a.each(function(a){var o=$(this),i=null;i=o.find(".checkbox"),n=i.length-1,i.length&&i.each(function(a){e+=$(this).data("id"),t.push($(this).data("id")),a<n&&(e+=",")}),a<s&&(e+="|")}),V.blur(),R.find(".btn-tag").each(function(){$(this).click()}),tt(t)):(u=!u,X.text(X.data("changetoresults")),N.find(".display").find('[data-group="tags"]').addClass("hidden"),g.hide(),le(!1),ue(!1),V.blur(),R.find(".btn-tag").each(function(){$(this).click()}),N.find(".fieldset-hidden").removeClass("fieldset-hidden"),L.toggleClass("section-hidden"),G.toggleClass("section-hidden"))},ve=function(e){var t=$(e.target),a=t,s=a.data("group"),n=e.format("yyyymmdd"),o=e.format("yyyy-mm-dd"),r=e.format("dd.mm.yyyy");i.setDate(""===o?"0":o,s),t.siblings('input[type="hidden"]').eq(0).val(n),Ue(-1!==s.indexOf("from")?"from":"to")},_e=function(){var e=$(this),t=e.parent(),a=e.is(":checked"),s=t.data("id");a?"sort"===t.data("group")?(Qe(".display",s,1),"d0"===s&&i.setDisplay(t.data("sort"),"sort")):"string"==typeof s&&-1!==s.indexOf("d")?(Qe(".display",s,1),i.setDisplay("1","d1"===s?"desc":"showtags"),"d1"===s&&Re()):(Qe(".tag-group",s,1),i.setTag(s.toString(),"add")):"string"==typeof s&&-1!==s.indexOf("d")?(Qe(".display",s,0),i.setDisplay("0","d1"===s?"desc":"showtags"),"d1"===s&&Re()):(Qe(".tag-group",s,0),i.setTag(s.toString(),"remove"))},be=function(){var e=Q.find("option:selected").eq(0),t=Q.siblings(".hidden").eq(0),a=e.val().toLowerCase();t.data("sort",a),i.setDisplay(a,"sort"),Re()},Ce=function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target),a=Q.siblings(".hidden").eq(0),s=t.data("sort");i.getDisplaySort()===s?"0"===i.getDisplayDesc()?(i.setDisplay("1","desc"),Qe(".display","d1",1)):(i.setDisplay("0","desc"),Qe(".display","d1",0)):i.setDisplay(s,"sort"),Re()},we=function(){var e=$(this),t=0;"searchquery"===e.data("group")?(N.find(".search-query").val(""),i.setText("")):"date-from"===e.data("group")?(I.datepicker("update",""),$("#date-from-eurodate").val(""),i.setDate("0","date-from")):"date-to"===e.data("group")?(j.datepicker("update",""),$("#date-to-eurodate").val(""),i.setDate("0","date-to")):"sort"===e.data("group")?(Q.val("name"),i.setDisplay("name","sort"),Re()):"display"===e.data("type")?(t=e.data("id"),J.find("label").filter('[data-id="'+t+'"]').find("input").prop("checked",!1),"d1"===t?(i.setDisplay("0","desc"),Re()):"d2"===t&&i.setDisplay("0","showtags")):(t=e.data("id"),J.find("label").filter('[data-id="'+t+'"]').find("input").prop("checked",!1),i.setTag(t,"remove")),e.remove(),"sort"===e.data("group")||"course"===e.data("type")||e.data("type")},xe=function(){var e=$(this),t=e.is(":checked"),a=null,s="",n="",o={};t?(s=e.data("group"),n=s,a=N.find('fieldset[data-group="'+n+'"]'),o=$.extend({},ee,{id:e.data("id"),type:e.data("type"),group:e.data("group"),name:e.data("name")}),oe(a,o)):N.find('[data-id="'+e.data("id")+'"]').remove()},De=function(e){var t=null,a="",s=null,n=null;t=$(e.currentTarget),a=t.val().toLowerCase(),s=G.find(".unlist"),n=s.find("label"),n.each(function(){var e=$(this);-1!==e.find("input").data("name").toLowerCase().indexOf(a)?e.parent("li").removeClass("hidden"):e.parent("li").addClass("hidden")}),""!==a?G.find(".accordion-body").each(function(){var e=$(this);e.has("li:not(.hidden)").length?e.collapse("show"):e.collapse("hide")}):G.find(".accordion-body").collapse("hide")},ke=function(e){var t=$(this),a;e.preventDefault(),a=t.find(".search-query").val(),i.setText(a),Ke()},Oe=function(){var e,t={};return e=N.find("label").has(":checked"),e.each(function(){var e=$(this);"course"===e.data("type")&&(t.hasOwnProperty(e.data("group"))||(t[e.data("group")]=[]),t[e.data("group")].push(e.data("group")+"-"+e.data("name")))}),t},Se=function(){var e,t=[];return e=N.find("label.checkbox"),e.each(function(){var e=$(this);"course"===e.data("type")&&t.push({id:e.data("id"),type:e.data("type"),name:e.data("name"),group:e.data("group"),groupid:e.data("groupid")})}),t},Te=function(){var e,t=[];return e=N.find("label").has(":checked"),e.each(function(){var e=$(this);"display"===e.data("type")&&("sort"===e.data("group")?t.push("sort-"+e.data("sort")):t.push(e.data("group")))}),t},qe=function(){var e=null,t=null,a=Te(),s="name",n=null;if(!m.length){var o;for(o in p)p.hasOwnProperty(o)&&m.push({id:p[o].id,sortorder:p[o].sortorder,sortdate:p[o].sortdate,availnumber:p[o].availnumber,deadline:p[o].deadline,municipality:p[o].municipality?p[o].municipality.toLowerCase():"",location:p[o].location?p[o].location.toLowerCase():""})}var i=function(e,t){return l?t[ae[s]]<e[ae[s]]?1:-1:t[ae[s]]>e[ae[s]]?1:-1};-1!==a.indexOf("tags")?L.find(".course-list").removeClass("tags-hidden"):L.find(".course-list").addClass("tags-hidden"),l=-1===a.indexOf("sortdesc"),a.forEach(function(e){-1!==e.indexOf("sort-")&&(s=e.replace("sort-",""))}),L.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),L.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc"),n=L.find(".course-list-col-titles").find('[data-sort="'+s+'"]'),l?n.addClass("sortasc"):n.addClass("sortdesc"),m.sort(i),y=[],m.forEach(function(e){y.push("c"+e.id)}),je()},Ie=function(){var e=null,t=null,a=Te(),s="name",n=null,o=function(e,t){return l?$(t).data(ae[s])<$(e).data(ae[s])?1:-1:$(t).data(ae[s])>$(e).data(ae[s])?1:-1};-1!==a.indexOf("tags")?L.find(".course-list").removeClass("tags-hidden"):L.find(".course-list").addClass("tags-hidden"),l=-1===a.indexOf("sortdesc"),a.forEach(function(e){-1!==e.indexOf("sort-")&&(s=e.replace("sort-",""))}),L.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),L.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc"),n=L.find(".course-list-col-titles").find('[data-sort="'+s+'"]'),l?n.addClass("sortasc"):n.addClass("sortdesc"),e=L.find("#tabcards").find(".course-cards").eq(0),e.html(e.children(".course-card-item").sort(o)),e=L.find("#tablist").find(".course-list").find("tbody").eq(0),e.html(e.children(".course-list-item").sort(o)),t=L.find("#tablist").find(".course-list"),t.find("tr:not(.hide-item)").each(function(e){e%2?$(this).removeClass("odd"):$(this).addClass("odd")})},je=function(){return t.debug("enter filterCourses"),new Promise(function(e,t){var a=Oe(),s=i.getText(),n=i.getFromDate(),o=0,r=i.getToDate(),d=0,c=""!==i.getText(),l=[],u,f,h=!1;if(v=y.slice(),!Object.keys(a).length&&!c&&"0"===n&&"0"===r)return void e(v);"0"===n&&"0"===r||(console.log(n,r),o=parseInt(n.replace(/-/g,""),10),d=parseInt(r.replace(/-/g,""),10),l=v.filter(function(e){if(u=p[e],f=parseInt(u.sortdate,10),o&&d){if(f>=o&&f<=d)return!0}else if(o){if(f>=o)return!0}else{if(!d)return!1;if(f<=d)return!0}}),l.length&&(h=!0,v=l.slice(),l=[])),c&&(l=v.filter(function(e){return u=p[e],u.hasOwnProperty("alltext")&&u.alltext&&-1!==u.alltext.indexOf(s)}),v=l.slice(),l.length?(h=!0,l=[]):h=!1),Object.keys(a).forEach(function(e){l=v.filter(function(t){var s=!1;return a[e].forEach(function(e){-1!==p[t].tagcollection.indexOf(e)&&(s=!0)}),s}),v=l.slice(),l.length?(h=!0,l=[]):h=!1}),h||(v=[-1]),e(v)})},Ee=function(e){return t.debug("enter sortFilteredCourses"),new Promise(function(t,a){t(o.chain(o.values(p)).filter(function(t){return-1!==e.indexOf("c"+t.id)}).orderBy(ae[i.getDisplaySort()],"0"===i.getDisplayDesc()?"asc":"desc").flatMap(function(e){return"c"+e.id}).value())})},Me=function(e){return t.debug("enter showFilteredCourses"),new Promise(function(t,a){var n,o;H.html(""),W&&W.children("tbody").html(""),e.length&&-1!==e[0]?(k=e.slice(),O=e.slice(),f=e.length,h.text(f),n={courses:[]},"0"===i.getView()?(o=k.splice(0,12),n.courses=o.map(function(e){return p[e]}),n.courses.length&&s.render("local_course_search/course_search_course_card_set",n).done(function(e){H.html(e),le(!0)})):"1"===i.getView()&&(o=O.splice(0,30),n.courses=o.map(function(e){return p[e]}),n.courses.length&&s.render("local_course_search/course_search_course_list_set",n).done(function(e){W.children("tbody").html(e),ue(!0)}))):(k=[],O=[],f=0,h.text(f)),t(e)})},Pe=function(e){var t=L.find(".course-cards"),a=L.find(".course-list");e.length?-1===e[0]?y.forEach(function(e){t.find("#coursecarditem-"+e).addClass("hide-item"),a.find("#courselistitem-"+e).addClass("hide-item")}):y.forEach(function(s){-1!==e.indexOf(s)?(t.find("#coursecarditem-"+s).removeClass("hide-item"),a.find("#courselistitem-"+s).removeClass("hide-item")):(t.find("#coursecarditem-"+s).addClass("hide-item"),a.find("#courselistitem-"+s).addClass("hide-item"))}):y.forEach(function(e){t.find("#coursecarditem-"+e).removeClass("hide-item"),a.find("#courselistitem-"+e).removeClass("hide-item")})},Fe=function(){return t.debug("enter getCoursedata"),new Promise(function(e,t){if(!1)return void e(!1);$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:S}}])[0]).then(function(t){var a=JSON.parse(t.coursedata);p=a.courses,y=Object.keys(p),v=y.slice(),k=y.slice(),O=y.slice(),L.find(".alert-info").remove(),f=y.length,h.text(f),g.show(),console.log("courses",p),console.log("courseids",y.slice()),e(!0)})})},Je=function(){$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:S}}])[0]).then(function(e){var t=JSON.parse(e.coursedata),a=[];s.render("local_course_search/course_search_course_list",{}),p=t.courses,y=Object.keys(p),k=y.slice(),O=y.slice(),f=y.length,h.text(f),g.show(),console.log("courses",p),console.log("courseids",y.slice()),a=k.splice(0,12),ie({courses:a.map(function(e){return p[e]})}),Be()})},Ne=function(){$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:S}}])[0]).then(function(e){var t=JSON.parse(e.coursedata),a={},s=[];p=t.courses,m=[],y=Object.keys(p),k=y.slice(),O=y.slice(),f=y.length,h.text(f),g.show(),console.log("changed courses",p),console.log("changed courseids",y.slice()),le(!0),he(12)})},Ve=function(e){return t.debug("enter saveInterests"),new Promise(function(t,s){var n={sesskey:M.cfg.sesskey,tags:e};$.when(a.call([{methodname:"local_course_search_save_search_criteria",args:{data:JSON.stringify(n)}}])[0]).then(function(e){var a=JSON.parse(e.result);u=!u,H.html(""),W&&W.children("tbody").html(""),N.find(".tag-group").not(":has(label.checkbox)").addClass("fieldset-hidden"),L.toggleClass("section-hidden"),G.toggleClass("section-hidden"),t(!0)})})},Le=function(){$.when(a.call([{methodname:"local_course_search_get_user_search_criteria",args:{userid:S}}])[0]).then(function(e){var a=JSON.parse(e.data);t.debug("get_user_search_criteria")})},Be=function(){Y||$.when(a.call([{methodname:"local_course_search_get_all_course_tags",args:{userid:S}}])[0]).then(function(e){var t=JSON.parse(e.data);ce(t)})},Ae=function(){Se().forEach(function(e){G.find('[data-id="'+e.id+'"]').attr("checked",!0)})},He=function(e){require(["javascript/locales/bootstrap-datepicker.no","javascript/locales/bootstrap-datepicker.de"],function(){I.datepicker({language:e,format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){ve(e)}),j.datepicker({language:e,format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){ve(e)})})},We=function(){var e=N.find(".display").find('[data-group="tags"]');z.find(".active").removeClass("active"),"0"===i.getView()?(t.debug("Show cards view"),e.addClass("hidden"),ze(0),$e(1)):"1"===i.getView()&&(t.debug("Show list view"),e.removeClass("hidden"),$e(0),ze(1))},$e=function(e){e?(z.find('a[href="#tabcards"]').parent("li").addClass("active"),B.addClass("active"),le(!0)):(B.removeClass("active"),le(!1))},ze=function(e){e?(z.find('a[href="#tablist"]').parent("li").addClass("active"),A.addClass("active"),ue(!0)):(A.removeClass("active"),ue(!1))},Ge=function(e,t){""!==e&&R.find("li").has(e).remove(),o.isObject(t)&&s.render("local_course_search/course_search_selected_tags_item",t).done(function(e){U.append(e)})},Ke=function(){var e=i.getText(),t;""!==e&&(t=$.extend({},te,{type:"course",group:"searchquery",name:e,pretext:M.str.local_course_search.searchtext})),Ge('[data-group="searchquery"]',t)},Qe=function(e,t,a){var s=N.find(e).find('.checkbox[data-id="'+t+'"]'),n="",o=null;a?(s.find("input").prop("checked",!0),o=$.extend({},te,{id:s.data("id"),type:s.data("type"),group:s.data("group"),name:s.data("name")}),"sort"===s.data("group")&&(o.sort=s.data("sort"),o.name=M.str.local_course_search.sortby+" "+M.str.local_friadmin[se[o.sort]],n='[data-group="sort"]'),Ge(n,o)):(s.find("input").prop("checked",!1),Ge('[data-id="'+s.data("id")+'"]',o))},Re=function(){var e;Q.val(i.getDisplaySort()),Q.siblings(".hidden").eq(0).data("sort",i.getDisplaySort()),L.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),L.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc");var t=L.find(".course-list-col-titles").find('[data-sort="'+i.getDisplaySort()+'"]');"0"===i.getDisplayDesc()?t.addClass("sortasc"):t.addClass("sortdesc"),e=$.extend({},te,{id:"d0",type:"display",group:"sort",sort:i.getDisplaySort(),name:M.str.local_course_search.sortby+" "+M.str.local_friadmin[se[i.getDisplaySort()]]}),Ge('[data-id="'+e.id+'"]',e)},Ue=function(e){var t="0",a="",s="",n=null;"from"===e?t=i.getFromDate():"to"===e&&(t=i.getToDate()),"0"!==t?("from"===e?(s=E.siblings('input[type="hidden"]').eq(0).val(),a=I.data("name")):"to"===e&&(s=P.siblings('input[type="hidden"]').eq(0).val(),a=j.data("name")),n=$.extend({},te,{id:"date-"+e,type:"course",group:"date-"+e,name:a,posttext:" "+s}),Ge('[data-id="date-'+e+'"]',n)):Ge('[data-id="date-'+e+'"]',null)},Xe=function(){"1"===i.getDisplayShowtags()?L.find(".course-list").removeClass("tags-hidden"):L.find(".course-list").addClass("tags-hidden")},Ye=function(){je().then(Ee).then(Me)},Ze=function(){Fe().then(function(e){e&&Ye()})},et=function(){Fe().then(function(e){Be(),e&&Ye()})},tt=function(e){Ve(e).then(Fe).then(function(e){e&&Ye()})},at=function(){var e;if(We(),""!==i.getText()){var a=i.getText();t.debug("Set search text to: "+a),V.val(a),Ke()}t.debug("Check tags: "),t.debug(i.getTags()),i.getTags().forEach(function(e){""!==e&&Qe(".tag-group",e,1)}),"0"!==i.getFromDate()&&o.delay(function(){I.datepicker("update",i.getFromDate().split("-").reverse().join(".")),Ue("from")},500),"0"!==i.getToDate()&&o.delay(function(){j.datepicker("update",i.getToDate().split("-").reverse().join(".")),Ue("to")},500),"1"===i.getDisplayDesc()&&Qe(".display","d1",1),Re(),"1"===i.getDisplayShowtags()&&Qe(".display","d2",1),Xe()};return{init:function(e){t.debug("AMD module init with lang "+e),i.init(),h=$("#actualCourseCount"),g=$("#actualCourseCountInfo"),F=$("#catalog-area"),S=parseInt(F.data("userid"),10),N=$("#course-search-form"),V=N.find("#course-search"),J=$("#search-area"),K=J.find(".form-search"),Q=J.find("#select-sort"),E=$("#date-from"),I=E.parents('[data-group="date-from"]'),P=$("#date-to"),j=P.parents('[data-group="date-to"]'),X=J.find("#switch-display"),L=$("#result-area"),z=L.find(".nav-tabs").eq(0),B=L.find("#tabcards"),A=L.find("#tablist"),H=L.find("#course-cards"),W=L.find("#course-list"),R=$("#tag-area"),U=R.find(".selected-tags"),G=$("#tag-preselect-area"),N.on("submit",ke),J.on("change",'[type="checkbox"]',_e),J.on("change","#select-sort",be),L.on("shown",'a[data-toggle="tab"]',me),L.on("click","th.coltitle",Ce),R.on("click","button",we),G.on("change",'[type="checkbox"]',xe),G.on("keyup","#tagFilter",De),X.on("click",ye),T=new r(H.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("cardsInfScroll init")}}),q=new r(W.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("listInfScroll init")}}),$("body").on("viewstate:change",function(e,a){t.debug("coursesearch:change",a),"view"===a||("showtags"===a?Xe():"sort"===a||"desc"===a?Ee(v).then(Me):Ye())}),He(e),at(),et()}}}});