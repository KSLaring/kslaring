define(["jquery","core/notification","core/log","core/ajax","core/templates","local_course_search/cookie","theme_bootstrapbase/bootstrap"],function($,e,t,a,n,r){"use strict";window.$=$,t.debug("AMD module loaded.");var o="name",d=!0,s=!1,i=!1,c=!1,l=[],u=[],f=0,h=null,p=null,g=null,m=null,_=null,v=null,y=null,b=null,x=null,C=!1,k="hide-item",w="preselectedtags",O="433,430,431,16,39,108,196,268,352|449,452,450,453|458,459|460,462,463",q={id:0,type:null,group:null,name:null},E={id:0,type:null,group:null,name:null,sort:null,pretext:null,posttext:null,remove:0},S={name:"sortorder",date:"sortdate",availseats:"availnumber",deadline:"deadline",municipality:"municipality",location:"location"},D=function(e){var t=e.tags.groups,a;t.length&&(t.forEach(function(e){a=$.grep(e.shown,function(e){return 1===e.checked}),a.length&&(l=$.merge(l,a))}),J({selectedCourseTags:l}))},J=function(e){n.render("local_course_search/course_search_selected_tags",e).done(function(e){y.append(e),b=y.find(".selected-tags")})},L=function(e){n.render("local_course_search/course_search_region_search",e).done(function(e){v.after(e),c=!0,B()})},N=function(e){n.render("local_course_search/course_search_result_area",e).done(function(t){e.hasOwnProperty("courses")&&e.courses.length?m.html(t):m.append(t),Z()})},j=function(e){n.render("local_course_search/course_search_tag_preselect_area",e).done(function(e){_.html(e),C=!0,ie()})},P=function(){if(!i&&C){var e=r.read("preselectedtags"),t=[],a=[],n=null;null!==e&&(t=e.split("|"),t.forEach(function(e){a.push(e.split(","))}),n=p.find(".tag-group"),n.length&&n.each(function(e){var t=$(this),n=null,r={};a[e].forEach(function(e){n=_.find('[data-id="'+e+'"]'),n.length&&(n.prop("checked",!0),r=$.extend({},q,{id:n.data("id"),type:n.data("type"),group:n.data("group"),name:n.data("name")}),A(t,r))})})),i=!0}},A=function(e,t){n.render("local_course_search/course_search_region_search_groups_item",t).done(function(t){e.append(t)})},B=function(){require(["local_course_search/Xloader"],function(){$("#date-from").datepicker({format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){H(e)}),$("#date-to").datepicker({format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){H(e)})})},H=function(e){var t=$(e.target),a=t.parents(".date"),r=e.format("yyyymmdd"),o=e.format("dd.mm.yyyy"),d=null,s=$.extend({},E,{type:a.data("type"),group:a.data("group"),name:a.data("name"),posttext:" "+o});t.siblings('input[type="hidden"]').eq(0).val(r),d=y.find("button").filter('[data-name="'+a.data("name")+'"]').parent("li").remove(),""===o?s.remove=1:n.render("local_course_search/course_search_selected_tags_item",s).done(function(e){b.append(e)}),ee(),Z()},T=function(){var e=$(this),t=e.parent(),a=e.is(":checked"),r=null,o=$.extend({},E,{id:t.data("id"),type:t.data("type"),group:t.data("group"),name:t.data("name")});a?"sort"===e.parent().data("group")?(r=y.find("button").filter('[data-group="sort"]').parent("li").remove(),o.sort=t.data("sort"),o.name="Sort by "+o.sort,n.render("local_course_search/course_search_selected_tags_item",o).done(function(e){b.append(e)})):n.render("local_course_search/course_search_selected_tags_item",o).done(function(e){b.append(e)}):(r=y.find("button").filter('[data-name="'+e.parent().data("name")+'"]').parent("li").remove(),o.remove=1),"course"===t.data("type")&&ee(),Z()},W=function(){var e=$(this),t=e.is(":checked"),a=null,n="",r="",o={};t?(n=e.data("group"),r="municipality"===n||"region"===n?"provider":n,a=g.find('fieldset[data-group="'+r+'"]'),o=$.extend({},q,{id:e.data("id"),type:e.data("type"),group:e.data("group"),name:e.data("name")}),A(a,o)):g.find('[data-id="'+e.data("id")+'"]').remove()},F=function(){var e=$(this),t=e.find("option:selected").eq(0),a=e.siblings(".hidden").eq(0),n="";n=t.val().toLowerCase(),o!==n&&(o=n,a.data("sort",n),a.find("input").trigger("change"))},I=function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target),a=p.find("#select-sort"),n=a.find("option"),r=a.siblings(".hidden").eq(0),s="";s=t.data("sort"),o===s?(d=!d,p.find('[data-group="sortdesc"]').find("input").click()):o=s,n.find(":selected").prop("selected",!1),n.filter(function(){return $(this).val()===s}).prop("selected",!0),r.data("sort",s),r.find("input").trigger("change")},X=function(){var e=$(this);"searchquery"===e.data("group")?g.find(".search-query").val(""):"date-from"===e.data("group")?($("#date-from").datepicker("update",""),$("#date-from-eurodate").val("")):"date-to"===e.data("group")?($("#date-to").datepicker("update",""),$("#date-to-eurodate").val("")):p.find("label").filter('[data-name="'+e.data("name")+'"]').find("input").prop("checked",!1),e.remove(),"course"===e.data("type")?ee():"display"===e.data("type")&&Z()},z=function(e){var t=null,a="",n=null,r=null;t=$(e.currentTarget),a=t.val().toLowerCase(),n=_.find(".unlist"),r=n.find("label"),r.each(function(){var e=$(this);-1!==e.find("input").data("name").toLowerCase().indexOf(a)?e.parent("li").removeClass("hidden"):e.parent("li").addClass("hidden")})},G=function(e){var t=$(this),a,r;e.preventDefault(),a=t.find(".search-query").val(),r=$.extend({},E,{type:"course",group:"searchquery",name:a,pretext:"Search text: "}),y.find("li").has('[data-group="searchquery"]').remove(),""!==a&&n.render("local_course_search/course_search_selected_tags_item",r).done(function(e){b.append(e)}),ee()},K=function(){return g.find("#course-search").val().toLowerCase()},Q=function(){var e,t=[];return e=g.find("label").has(":checked"),e.each(function(){var e=$(this);"course"===e.data("type")&&t.push(e.data("group")+"-"+e.data("name"))}),t},R=function(){var e,t=[];return e=g.find("label.checkbox"),e.each(function(){var e=$(this);"course"===e.data("type")&&t.push({id:e.data("id"),type:e.data("type"),name:e.data("name"),group:e.data("group"),groupid:e.data("groupid")})}),t},U=function(){var e={from:null,to:null,datesset:!1},t;return t=$("#date-from-eurodate").val(),""!==t&&(e.from=t,e.datesset=!0),t=$("#date-to-eurodate").val(),""!==t&&(e.to=t,e.datesset=!0),e},V=function(){var e,t=[];return e=g.find("label").has(":checked"),e.each(function(){var e=$(this);"display"===e.data("type")&&("sort"===e.data("group")?t.push("sort-"+e.data("sort")):t.push(e.data("group")))}),t},Y=function(){var e,t=[];return e=_.find("input:checked"),e.each(function(){t.push($(this).data("id"))}),t},Z=function(){var e=null,t=null,a=V(),n="name",r=null,o=function(e,t){return d?$(t).data(S[n])<$(e).data(S[n])?1:-1:$(t).data(S[n])>$(e).data(S[n])?1:-1};-1!==a.indexOf("tags")?m.find(".course-list").removeClass("tags-hidden"):m.find(".course-list").addClass("tags-hidden"),d=-1===a.indexOf("sortdesc"),a.forEach(function(e){-1!==e.indexOf("sort-")&&(n=e.replace("sort-",""))}),m.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),m.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc"),r=m.find(".course-list-col-titles").find('[data-sort="'+n+'"]'),d?r.addClass("sortasc"):r.addClass("sortdesc"),e=m.find("#tabcards").find(".course-cards").eq(0),e.html(e.children(".course-card-item").sort(o)),e=m.find("#tablist").find(".course-list").find("tbody").eq(0),e.html(e.children(".course-list-item").sort(o)),t=m.find("#tablist").find(".course-list"),t.find("tr:not(.hide-item)").each(function(e){e%2?$(this).removeClass("odd"):$(this).addClass("odd")})},ee=function(){var e=Q(),t=K(),a=U(),n=""!==t,r=[],o,d,s,i,c,l;for(o=n?e.length+1:e.length,o+=a.datesset?1:0,s=0,i=u.length;s<i;s++){var f=u[s];for(d=0,n&&f.hasOwnProperty("alltext")&&f.alltext&&-1!==f.alltext.indexOf(t)&&d++,c=0,l=e.length;c<l;c++)-1!==f.tagcollection.indexOf(e[c])&&d++;null!==a.from&&null!==a.to?f.sortdate>=a.from&&f.sortdate<=a.to&&d++:null!==a.from?f.sortdate>=a.from&&d++:null!==a.to&&f.sortdate<=a.to&&d++,d===o&&r.push(f.id)}!r.length&&o&&r.push(-1),te(r)},te=function(e){var t=m.find(".course-cards"),a=m.find(".course-list");e.length?-1===e[0]?u.forEach(function(e){t.find("#coursecarditem-"+e.id).addClass("hide-item"),a.find("#courselistitem-"+e.id).addClass("hide-item")}):u.forEach(function(n){-1!==e.indexOf(n.id)?(t.find("#coursecarditem-"+n.id).removeClass("hide-item"),a.find("#courselistitem-"+n.id).removeClass("hide-item")):(t.find("#coursecarditem-"+n.id).addClass("hide-item"),a.find("#courselistitem-"+n.id).addClass("hide-item"))}):u.forEach(function(e){t.find("#coursecarditem-"+e.id).removeClass("hide-item"),a.find("#courselistitem-"+e.id).removeClass("hide-item")})},ae=function(){var e="",t=[],a=null,n,o;s?(a=p.find(".tag-group"),n=a.length-1,a.length&&a.each(function(a){var r=$(this),d=null;d=r.find(".checkbox"),o=d.length-1,d.length&&d.each(function(a){e+=$(this).data("id"),t.push($(this).data("id")),a<o&&(e+=",")}),a<n&&(e+="|")}),r.create("preselectedtags",e,14),oe(t)):(s=!s,m.toggleClass("section-hidden"),_.toggleClass("section-hidden"))},ne=function(e){var t=[],a=[],n=[];return $.each(e,function(e,r){t=[],a=[],n.push(r.id),$.each(r.tags,function(e,n){a.push(n.group+"-"+n.name),t.push(n.name)}),r.tagcollection=a,r.alltext=t.join(","),r.alltext+=" "+r.name+" "+r.summary,r.alltext=r.alltext.toLowerCase()}),e.courseids=n,e},re=function(){$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:f}}])[0]).then(function(e){var t=JSON.parse(e.coursedata);u=t.courses,N(t),se()})},oe=function(e){var t={sesskey:M.cfg.sesskey,tags:e};$.when(a.call([{methodname:"local_course_search_save_search_criteria",args:{data:JSON.stringify(t)}}])[0]).then(function(e){var t=JSON.parse(e.result);s=!s,m.html(""),re(!1),m.toggleClass("section-hidden"),_.toggleClass("section-hidden")})},de=function(){$.when(a.call([{methodname:"local_course_search_get_user_search_criteria",args:{userid:f}}])[0]).then(function(e){var a=JSON.parse(e.data);t.debug("get_user_search_criteria")})},se=function(){C||$.when(a.call([{methodname:"local_course_search_get_all_course_tags",args:{userid:f}}])[0]).then(function(e){var t=JSON.parse(e.data);j(t)})},ie=function(){R().forEach(function(e){_.find('[data-id="'+e.id+'"]').attr("checked",!0)})};return{init:function(){t.debug("AMD module init."),null===r.read("preselectedtags")&&r.create("preselectedtags","433,430,431,16,39,108,196,268,352|449,452,450,453|458,459|460,462,463"),h=$("#catalog-area"),f=parseInt(h.data("userid"),10),p=$("#search-area"),g=$("#course-search-form"),m=$("#result-area"),_=$("#tag-preselect-area"),y=$("#tag-area"),b=y.find(".selected-tags"),v=p.find(".form-search"),x=p.find("#switch-display"),re(),p.on("change",'[type="checkbox"]',T),p.on("change","select",F),m.on("click","th.coltitle",I),y.on("click","button",X),_.on("change",'[type="checkbox"]',W),_.on("keyup","#tagFilter",z),g.on("submit",G),x.on("click",ae),B()}}});