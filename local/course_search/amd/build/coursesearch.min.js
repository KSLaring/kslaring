/*global require: false, define: false, M: true, console: false */
define(['jquery', 'core/notification', 'core/log', 'core/ajax', 'core/templates', 'local_course_search/cookie', 'theme_bootstrapbase/bootstrap'],
    function ($, notification, log, ajax, templates, cookie) {
        "use strict";

        // Add the jQuery object globaly or debugging.
        window.$ = $;

        log.debug('AMD module loaded.');

        var sortbystate = 'name',
            sortascstate = true,
            showtagliststate = false,
            preselectedTagsAddedState = false,
            searcharearenderedstate = false,
            selectedCourseTags = [],
            courses = {},
            courseids = [],
            userid = 0,
            $catalogarea = null,
            $searcharea = null,
            $coursesearchform = null,
            $coursesearchfield = null,
            $resultarea = null,
            $navtabs = null,
            $tagpreselectarea = null,
            $formsearch = null,
            $tagarea = null,
            $selectedCourseTags = null,
            $switchDisplay = null,
            preselecttagsloaded = false,
            hideitemClass = 'hide-item',
            cookiename = 'preselectedtags',
            // The preselected tags are sotored in a cookie. The tag ids are sepaarated by commy,
            // the sections are separated by »|«.
            preselectedtags = '433,430,431,16,39,108,196,268,352|449,452,450,453|458,459|460,462,463',
            tagContextObj = {id: 0, type: null, group: null, name: null},
            activityContextObj = {id: 0, type: null, group: null, name: null, sort: null, pretext: null, posttext: null, remove: 0},
            col2sortfieldmap = {
                'name': 'sortorder',
                'date': 'sortdate',
                'availseats': 'availnumber',
                'deadline': 'deadline',
                'municipality': 'municipality',
                'location': 'location'
            },
            sortstrmapping = {
                'name': 'course_name',
                'date': 'course_date',
                'availseats': 'course_seats',
                'deadline': 'course_deadline',
                'municipality': 'course_municipality',
                'location': 'course_location'
            };

        var grepselectedCourseTags = function (data) {
            var groups = data.tags.groups,
                found;

            if (groups.length) {
                groups.forEach(function (val) {
                    found = $.grep(val.shown, function (item) {
                        return (item.checked === 1);
                    });

                    if (found.length) {
                        selectedCourseTags = $.merge(selectedCourseTags, found);
                    }
                });

                renderselectedCourseTags({selectedCourseTags: selectedCourseTags});
            }
        };

        var renderselectedCourseTags = function (context) {
            templates
                .render('local_course_search/course_search_selected_tags', context)
                .done(function (html) {
                    $tagarea.append(html);
                    $selectedCourseTags = $tagarea.find('.selected-tags');
                });
        };

        var renderSearchArea = function (context) {
            templates
                .render('local_course_search/course_search_region_search', context)
                .done(function (html) {
                    $formsearch.after(html);

                    searcharearenderedstate = true;

                    activateDatePicker();
                    // addPreselectedTags();
                });
        };

        var renderDisplayArea = function (context) {
            templates
                .render('local_course_search/course_search_result_area', context)
                .done(function (html) {
                    if (context.hasOwnProperty('courses') && context.courses.length) {
                        $resultarea.html(html);
                    } else {
                        $resultarea.append(html);
                    }

                    $navtabs = $('.nav-tabs').eq(0);
                    // $navtabs.on('click', handleTabChange);
                    $('a[data-toggle="tab"]').on('shown', handleTabChange);

                    updateCourseDisplay();
                });
        };

        var renderTagPreselectArea = function (context) {
            templates
                .render('local_course_search/course_search_tag_preselect_area', context)
                .done(function (html) {
                    $tagpreselectarea.html(html);

                    preselecttagsloaded = true;

                    setCheckboxForPreselectedTags();
                    // addPreselectedTags();
                });
        };

        var addPreselectedTags = function () {
            if (preselectedTagsAddedState) {
                return;
            }

            if (!preselecttagsloaded) {
                return;
            }

            var tags = cookie.read(cookiename),
                tagarray = [],
                tagarrayextracted = [],
                $taggroups = null;

            // Create an array of arrays from the cookie data.
            if (tags !== null) {
                tagarray = tags.split('|');
                tagarray.forEach(function (ele) {
                    tagarrayextracted.push(ele.split(','));
                });

                $taggroups = $searcharea.find('.tag-group');
                if ($taggroups.length) {
                    $taggroups.each(function (i) {
                        var $group = $(this),
                            $onetag = null,
                            tagcontext = {};

                        tagarrayextracted[i].forEach(function (ele) {
                            $onetag = $tagpreselectarea.find('[data-id="' + ele + '"]');
                            if ($onetag.length) {
                                $onetag.prop('checked', true);
                                tagcontext = $.extend({}, tagContextObj, {
                                    id: $onetag.data('id'),
                                    type: $onetag.data('type'),
                                    group: $onetag.data('group'),
                                    name: $onetag.data('name')
                                });

                                renderSearchTagItem($group, tagcontext);
                            }
                        });
                    });
                }
            }

            preselectedTagsAddedState = true;
        };


        var renderSearchTagItem = function ($where, context) {
            templates
                .render('local_course_search/course_search_region_search_groups_item', context)
                .done(function (html) {
                    $where.append(html);
                });
        };

        var activateDatePicker = function () {
            // Bootstrap 2.x datepicker https://github.com/uxsolutions/bootstrap-datepicker/tree/1.5.
            require(['local_course_search/Xloader'], function () {
                $("#date-from").datepicker({
                    format: "dd.mm.yyyy",
                    calendarWeeks: true,
                    todayHighlight: true,
                    clearBtn: true,
                    autoclose: true
                }).on("changeDate", function (e) {
                    dateChangeHandler(e);
                });
                $("#date-to").datepicker({
                    format: "dd.mm.yyyy",
                    calendarWeeks: true,
                    todayHighlight: true,
                    clearBtn: true,
                    autoclose: true
                }).on("changeDate", function (e) {
                    dateChangeHandler(e);
                });
            });
        };

        var dateChangeHandler = function (e) {
            var $ele = $(e.target),
                $parent = $ele.parents('.date'),
                dateEuro = e.format("yyyymmdd"),
                dateUser = e.format("dd.mm.yyyy"),
                $relatedTag = null,
                activityContext = $.extend({}, activityContextObj, {
                    type: $parent.data('type'),
                    group: $parent.data('group'),
                    name: $parent.data('name'),
                    posttext: " " + dateUser
                });
            $ele.siblings('input[type="hidden"]').eq(0).val(dateEuro);

            // Remove or add the related tag in the selected tag list depending on the checked status.
            // Remove an eventually existing tag.
            $relatedTag = $tagarea
                .find('button')
                .filter('[data-name="' + $parent.data('name') + '"]')
                .parent('li')
                .remove();
            if (dateUser === "") {
                activityContext.remove = 1;
            } else {
                templates
                    .render('local_course_search/course_search_selected_tags_item', activityContext)
                    .done(function (html) {
                        $selectedCourseTags.append(html);
                    });
            }

            filterCourses();
            updateCourseDisplay();
        };

        var checkboxChangeHandler = function () {
            var $ele = $(this),
                $parent = $ele.parent(),
                checked = $ele.is(":checked"),
                $relatedTag = null,
                activityContext = $.extend({}, activityContextObj, {
                    id: $parent.data('id'),
                    type: $parent.data('type'),
                    group: $parent.data('group'),
                    name: $parent.data('name')
                });

            // Remove or add the related tag in the selected tag list depending on the checked status.
            if (!checked) {
                $relatedTag = $tagarea
                    .find('button')
                    .filter('[data-name="' + $ele.parent().data('name') + '"]')
                    .parent('li')
                    .remove();
                activityContext.remove = 1;
            } else if ($parent.data('group') === 'sort') {
                // If the sort changed then remove the exisiting sort tag and add the new.
                $relatedTag = $tagarea
                    .find('button')
                    .filter('[data-group="sort"]')
                    .parent('li')
                    .remove();

                // Prepare sort related data.
                activityContext.sort = $parent.data('sort');
                activityContext.name = M.str.local_course_search.sortby + " " +
                    M.str.local_friadmin[sortstrmapping[activityContext.sort]];
                console.log($ele, $parent);
                templates
                    .render('local_course_search/course_search_selected_tags_item', activityContext)
                    .done(function (html) {
                        $selectedCourseTags.append(html);
                    });
            } else {
                templates
                    .render('local_course_search/course_search_selected_tags_item', activityContext)
                    .done(function (html) {
                        $selectedCourseTags.append(html);
                    });
            }

            if ($parent.data('type') === 'course') {
                filterCourses();
            }
            updateCourseDisplay();
        };

        var preselectedCheckboxChangeHandler = function () {
            var $ele = $(this),
                checked = $ele.is(":checked"),
                $group = null,
                group = '',
                displaygroup = '',
                tagcontext = {};

            if (!checked) {
                $coursesearchform.find('[data-id="' + $ele.data('id') + '"]').remove();
            } else {
                group = $ele.data('group');

                // Hack to speed up. Add provider as a data property.
                // Don't use for testing.
                // if (group === 'municipality' || group === 'region') {
                //     displaygroup = 'provider';
                // } else {
                //     displaygroup = group;
                // }
                displaygroup = group;

                $group = $coursesearchform.find('fieldset[data-group="' + displaygroup + '"]');
                tagcontext = $.extend({}, tagContextObj, {
                    id: $ele.data('id'),
                    type: $ele.data('type'),
                    group: $ele.data('group'),
                    name: $ele.data('name')
                });

                renderSearchTagItem($group, tagcontext);
            }
        };

        var sortSelectHandler = function () {
            var $ele = $(this),
                $selected = $ele.find("option:selected").eq(0),
                $relatedCheckboxLabel = $ele.siblings('.hidden').eq(0),
                selecteditem = '';

            selecteditem = $selected.val().toLowerCase();

            if (sortbystate === selecteditem) {
                return;
            } else {
                sortbystate = selecteditem;
            }

            $relatedCheckboxLabel.data('sort', selecteditem);
            $relatedCheckboxLabel
                .find('input')
                .trigger('change');
        };

        var colTitleClickHandler = function (e) {
            e.preventDefault();
            e.stopPropagation();

            var $target = $(e.target),
                $selectSort = $searcharea.find('#select-sort'),
                $selectSortOptions = $selectSort.find('option'),
                $relatedCheckboxLabel = $selectSort.siblings('.hidden').eq(0),
                sortwhat = '';

            sortwhat = $target.data('sort');

            if (sortbystate === sortwhat) {
                sortascstate = !sortascstate;
                $searcharea.find('[data-group="sortdesc"]').find('input').click();
            } else {
                sortbystate = sortwhat;
            }

            $selectSortOptions.find(':selected').prop('selected', false);
            $selectSortOptions.filter(function () {
                return ($(this).val() === sortwhat); // To select the related option
            }).prop('selected', true);

            $relatedCheckboxLabel.data('sort', sortwhat);
            $relatedCheckboxLabel
                .find('input')
                .trigger('change');
        };

        var selectedTagClickHandler = function () {
            var $ele = $(this);

            if ($ele.data('group') === 'searchquery') {
                $coursesearchform.find('.search-query').val('');
            } else if ($ele.data('group') === 'date-from') {
                $("#date-from").datepicker('update', '');
                $("#date-from-eurodate").val('');
            } else if ($ele.data('group') === 'date-to') {
                $("#date-to").datepicker('update', '');
                $("#date-to-eurodate").val('');
            } else {
                $searcharea
                    .find('label')
                    .filter('[data-name="' + $ele.data('name') + '"]')
                    .find('input').prop('checked', false);
            }

            $ele.remove();

            if ($ele.data('type') === 'course') {
                filterCourses();
            } else if ($ele.data('type') === 'display') {
                updateCourseDisplay();
            }
        };

        var handleTagFilterText = function (e) {
            var $input = null,
                filter = '',
                $tagLists = null,
                $tags = null;


            $input = $(e.currentTarget);
            filter = $input.val().toLowerCase();
            $tagLists = $tagpreselectarea.find('.unlist');
            $tags = $tagLists.find('label');

            $tags.each(function () {
                var $ele = $(this);
                if ($ele.find('input').data('name').toLowerCase().indexOf(filter) !== -1) {
                    $ele.parent('li').removeClass('hidden');
                } else {
                    $ele.parent('li').addClass('hidden');
                }
            });

            // Open all groups with found tags, hide those without.
            if (filter !== '') {
                $tagpreselectarea
                    .find('.accordion-body')
                    .each(function () {
                        var ele = $(this);
                        if (ele.has('li:not(.hidden)').length) {
                            ele.collapse('show');
                        } else {
                            ele.collapse('hide');
                        }
                    });
            } else {
                $tagpreselectarea
                    .find('.accordion-body')
                    .collapse('hide');
            }
        };

        var handleTextSearch = function (e) {
            var $form = $(this),
                text,
                activityContext;

            // Don't trigger form submit action for the page.
            e.preventDefault();

            text = $form.find('.search-query').val();
            activityContext = $.extend({}, activityContextObj, {
                type: 'course',
                group: 'searchquery',
                name: text,
                pretext: 'Search text: '
            });

            // Remove a possibly present search text tag.
            $tagarea.find('li').has('[data-group="searchquery"]').remove();

            // Add the search string as a tag.
            if (text !== '') {
                templates
                    .render('local_course_search/course_search_selected_tags_item', activityContext)
                    .done(function (html) {
                        $selectedCourseTags.append(html);
                    });
            }

            filterCourses();
        };

        var getSelectedSearchText = function () {
            return $coursesearchfield.val().toLowerCase();
        };

        var getSelectedCourseTags = function () {
            var checkeditems,
                searchItems = [];

            checkeditems = $coursesearchform.find('label').has(':checked');
            checkeditems.each(function () {
                var $item = $(this);
                if ($item.data('type') === 'course') {
                    searchItems.push($item.data('group') + '-' + $item.data('name'));
                }
            });

            return searchItems;
        };

        var getSelectedCourseTagsGrouped = function () {
            var checkeditems,
                searchItemsObj = {};

            checkeditems = $coursesearchform.find('label').has(':checked');
            checkeditems.each(function () {
                var $item = $(this);
                if ($item.data('type') === 'course') {
                    if (!searchItemsObj.hasOwnProperty($item.data('group'))) {
                        searchItemsObj[$item.data('group')] = [];
                    }
                    searchItemsObj[$item.data('group')].push($item.data('group') + '-' + $item.data('name'));
                }
            });

            return searchItemsObj;
        };

        var getPreselectedCourseTagObjects = function () {
            var checkeditems,
                searchItems = [];

            checkeditems = $coursesearchform.find('label.checkbox');
            checkeditems.each(function () {
                var $item = $(this);
                if ($item.data('type') === 'course') {
                    searchItems.push({
                        'id': $item.data('id'),
                        'type': $item.data('type'),
                        'name': $item.data('name'),
                        'group': $item.data('group'),
                        'groupid': $item.data('groupid')
                    });
                }
            });

            return searchItems;
        };

        var getSelectedFromToDates = function () {
            var dates = {
                    from: null,
                    to: null,
                    datesset: false
                },
                date;

            // Check and set the from date.
            date = $("#date-from-eurodate").val();
            if (date !== "") {
                dates.from = date;
                dates.datesset = true;
            }

            // Check and set the to date.
            date = $("#date-to-eurodate").val();
            if (date !== "") {
                dates.to = date;
                dates.datesset = true;
            }

            return dates;
        };

        var getSelectedDisplayTags = function () {
            var checkeditems,
                displayItems = [];

            checkeditems = $coursesearchform.find('label').has(':checked');
            checkeditems.each(function () {
                var $item = $(this);
                if ($item.data('type') === 'display') {
                    if ($item.data('group') === 'sort') {
                        displayItems.push('sort-' + $item.data('sort'));
                    } else {
                        displayItems.push($item.data('group'));
                    }
                }
            });

            return displayItems;
        };

        var getPreselectedTags = function () {
            var checkeditems,
                searchItems = [];

            checkeditems = $tagpreselectarea.find('input:checked');
            checkeditems.each(function () {
                searchItems.push($(this).data('id'));
            });

            return searchItems;
        };

        /**
         * Sort the displayed courses.
         *
         * Get the active sort criteria and sort the courses.
         */
        var updateCourseDisplay = function () {
            var $list = null,
                $sortedlist = null,
                selectedDisplayTags = getSelectedDisplayTags(),
                what = 'name',
                $coltitle = null;

            var sortFkt = function (a, b) {
                if (sortascstate) {
                    return ($(b).data(col2sortfieldmap[what])) < ($(a).data(col2sortfieldmap[what])) ? 1 : -1;
                } else {
                    return ($(b).data(col2sortfieldmap[what])) > ($(a).data(col2sortfieldmap[what])) ? 1 : -1;
                }
            };

            if (selectedDisplayTags.indexOf('tags') !== -1) {
                $resultarea.find(".course-list").removeClass('tags-hidden');
            } else {
                $resultarea.find(".course-list").addClass('tags-hidden');
            }

            sortascstate = selectedDisplayTags.indexOf('sortdesc') === -1;

            selectedDisplayTags.forEach(function (item) {
                if (item.indexOf('sort-') !== -1) {
                    what = item.replace('sort-', '');
                }
            });

            // Set the CSS class to show the sort arrow.
            $resultarea.find('.course-list-col-titles').find('.sortasc').removeClass('sortasc');
            $resultarea.find('.course-list-col-titles').find('.sortdesc').removeClass('sortdesc');

            $coltitle = $resultarea.find('.course-list-col-titles').find('[data-sort="' + what + '"]');
            if (sortascstate) {
                $coltitle.addClass('sortasc');
            } else {
                $coltitle.addClass('sortdesc');
            }

            $list = $resultarea.find("#tabcards").find('.course-cards').eq(0);
            $list.html($list.children('.course-card-item').sort(sortFkt));
            $list = $resultarea.find("#tablist").find('.course-list').find('tbody').eq(0);
            $list.html($list.children('.course-list-item').sort(sortFkt));

            // Set the »odd« class for alternating row colors only for the visible rows.
            $sortedlist = $resultarea.find("#tablist").find('.course-list');
            $sortedlist.find('tr:not(.hide-item)').each(function (i) {
                if (i % 2) {
                    $(this).removeClass('odd');
                } else {
                    $(this).addClass('odd');
                }
            });
        };

        /**
         * Walk all course items in the course data object and collect the ids of the matching courses.
         * Check if any of the selected search criteria match, if one matches add the id to the show list.
         * The rules for matches are:
         * _ OR the matches within one tag group
         * _ AND the group matches, the freetext and the date
         *
         * Then walk the course nodes in the display area and set the display status.
         */
        var filterCourses = function () {
            var selectedCourseTagsGrouped = getSelectedCourseTagsGrouped(),
                searchText = getSelectedSearchText(),
                fromtoDates = getSelectedFromToDates(), // array with the [from, to] dates
                hasTextSearch = (searchText !== ''),
                courseIDsFiltered = cloneArray(courseids),
                filtered = [],
                thecourse,
                foundany = false;

            // If no search criterion is set show all courses.
            if (!Object.keys(selectedCourseTagsGrouped).length && '' === searchText &&
                fromtoDates.from === null && fromtoDates.to === null) {
                showHideCourses(courseIDsFiltered);
                return;
            }

            // Check if the course dates match the chosen dates.
            if (fromtoDates.from !== null || fromtoDates.to !== null) {
                filtered = courseIDsFiltered.filter(function (id) {
                    thecourse = courses[id];
                    if (fromtoDates.from !== null && fromtoDates.to !== null) {
                        if (thecourse.sortdate >= fromtoDates.from && thecourse.sortdate <= fromtoDates.to) {
                            return true;
                        }
                    } else if (fromtoDates.from !== null) {
                        if (thecourse.sortdate >= fromtoDates.from) {
                            return true;
                        }
                    } else if (fromtoDates.to !== null) {
                        if (thecourse.sortdate <= fromtoDates.to) {
                            return true;
                        }
                    } else {
                        return false;
                    }
                });

                if (filtered.length) {
                    foundany = true;
                    courseIDsFiltered = cloneArray(filtered);
                    filtered = [];
                }
            }

            // Check if the text index contains the search string.
            if (hasTextSearch) {
                filtered = courseIDsFiltered.filter(function (id) {
                    thecourse = courses[id];
                    return (thecourse.hasOwnProperty('alltext') && thecourse.alltext &&
                    thecourse.alltext.indexOf(searchText) !== -1);
                });

                courseIDsFiltered = cloneArray(filtered);
                if (filtered.length) {
                    foundany = true;
                    filtered = [];
                } else {
                    foundany = false;
                }
            }

            // Filter the tags. Within a tag group use OR, between the tag groups AND.
            Object.keys(selectedCourseTagsGrouped).forEach(function (key) {
                filtered = courseIDsFiltered.filter(function (id) {
                    // Use OR - any group tag will be positive.
                    var found = false;
                    selectedCourseTagsGrouped[key].forEach(function (item) {
                        if (courses[id].tagcollection.indexOf(item) !== -1) {
                            found = true;
                        }
                    });

                    return found;
                });

                // Use AND - reduce the found courses list to the found courses for the next tag group.
                courseIDsFiltered = cloneArray(filtered);
                if (filtered.length) {
                    foundany = true;
                    filtered = [];
                } else {
                    foundany = false;
                }
            });

            // If tags are selected but no courses match then set the id list to -1.
            if (!foundany) {
                courseIDsFiltered = [-1];
            }

            showHideCourses(courseIDsFiltered);
        };

        /**
         * Clone an array
         *
         * @param inArray
         * @returns {Array}
         */
        var cloneArray = function (inArray) {
            return inArray.slice(0);
        };

        /**
         * Set the visibility of the courses in the cards and list view.
         *
         * @param courseIDsToShow The list of course ids to show
         */
        var showHideCourses = function (courseIDsToShow) {
            var $coursecards = $resultarea.find('.course-cards'),
                $courselist = $resultarea.find('.course-list');

            if (courseIDsToShow.length) {
                // If first item is -1 then hide all courses.
                if (courseIDsToShow[0] === -1) {
                    courseids.forEach(function (item) {
                        $coursecards.find('#coursecarditem-' + item).addClass(hideitemClass);
                        $courselist.find('#courselistitem-' + item).addClass(hideitemClass);
                    });
                } else {
                    courseids.forEach(function (item) {
                        if (courseIDsToShow.indexOf(item) !== -1) {
                            $coursecards.find('#coursecarditem-' + item).removeClass(hideitemClass);
                            $courselist.find('#courselistitem-' + item).removeClass(hideitemClass);
                        } else {
                            $coursecards.find('#coursecarditem-' + item).addClass(hideitemClass);
                            $courselist.find('#courselistitem-' + item).addClass(hideitemClass);
                        }
                    });
                }
            } else {
                courseids.forEach(function (item) {
                    $coursecards.find('#coursecarditem-' + item).removeClass(hideitemClass);
                    $courselist.find('#courselistitem-' + item).removeClass(hideitemClass);
                });
            }
        };

        var handleToggleTagPreselectPage = function () {
            var taglist = '',
                tagarray = [],
                $taggroups = null,
                gl,
                tl;

            // Save the tag selection in the cookie.
            if (showtagliststate) {
                $taggroups = $searcharea.find('.tag-group');
                gl = $taggroups.length - 1;
                if ($taggroups.length) {
                    $taggroups.each(function (i) {
                        var $group = $(this),
                            $tags = null;

                        $tags = $group.find('.checkbox');

                        tl = $tags.length - 1;
                        if ($tags.length) {
                            $tags.each(function (j) {
                                taglist += $(this).data('id');
                                tagarray.push($(this).data('id'));

                                if (j < tl) {
                                    taglist += ',';
                                }
                            });
                        }

                        if (i < gl) {
                            taglist += '|';
                        }
                    });
                }
                cookie.create(cookiename, taglist, 14);

                // Remove all search criteria.
                $coursesearchfield.blur();
                $tagarea
                    .find('.btn-tag')
                    .each(function () {
                        $(this).click();
                    });

                save_search_criteria(tagarray);
            } else {
                showtagliststate = !showtagliststate;

                // Remove all search criteria.
                $coursesearchfield.blur();
                $tagarea
                    .find('.btn-tag')
                    .each(function () {
                        $(this).click();
                    });

                $coursesearchform.find('.fieldset-hidden').removeClass('fieldset-hidden');

                $resultarea.toggleClass('section-hidden');
                $tagpreselectarea.toggleClass('section-hidden');
            }
        };

        /**
         * Handle the cards/list tab change event.
         *
         * When the cards are shown disable the »Show course tags« checkbox.
         *
         * @param e The event object
         */
        var handleTabChange = function (e) {
            var target = $(e.target).attr("href"),
                $showtagscheckbox = $coursesearchform.find('.display').find('[data-group="tags"]'),
                $input = $showtagscheckbox.find('input');

            if (target === '#tabcards') {
                $showtagscheckbox.addClass('disabled');
                if ($input.is(":checked")) {
                    $input.trigger('click');
                }
                $input.attr('disabled', 'disabled');
            } else if (target === '#tablist') {
                $showtagscheckbox.removeClass('disabled');
                $input.removeAttr('disabled');
            }
        };

        /**
         * Collect all texts from the course title and summary and the tag names into one text string
         * to speed up the text and the tag filter.
         *
         * add
         * {array} tagcollection as [{group}-{name}]
         * {string} textcollection as tagnames + coursename + coursesummary
         *
         * @param {array} data
         * @returns {array} the extended data
         */
        var indexCourseData_o = function (data) {
            var taglist = [],
                tagcollection = [],
                courseids = [];

            // Collect all text.
            $.each(data, function (i, item) {
                taglist = [];
                tagcollection = [];

                courseids.push(item.id);

                // Collect all tag names.
                $.each(item.tags, function (i, tag) {
                    tagcollection.push(tag.group + '-' + tag.name);
                    taglist.push(tag.name);
                });

                // Collect the tag names and the course name and summary.
                item.tagcollection = tagcollection;
                item.alltext = taglist.join(',');
                item.alltext += ' ' + item.name + ' ' + item.summary;
                item.alltext = item.alltext.toLowerCase();
            });

            data.courseids = courseids;

            return data;
        };

        var get_coursedata = function () {
            $.when(
                ajax.call([
                    {
                        methodname: 'local_course_search_get_course_data',
                        args: {
                            userid: userid
                        }
                    }
                ])[0]
            ).then(function (response) {
                var coursedata = JSON.parse(response.coursedata);
                courses = coursedata.courses;

                courseids = Object.keys(courses);
                renderDisplayArea({
                    'courses': courseids.map(function (k) {
                        return courses[k];
                    })
                });

                // And now get the course tags.
                get_all_course_tags();
            });
        };

        var save_search_criteria = function (tagarray) {
            var data = {
                sesskey: M.cfg.sesskey,
                tags: tagarray
            };
            $.when(
                ajax.call([
                    {
                        methodname: 'local_course_search_save_search_criteria',
                        args: {
                            data: JSON.stringify(data)
                        }
                    }
                ])[0]
            ).then(function (response) {
                var result = JSON.parse(response.result);
                showtagliststate = !showtagliststate;

                // window.location.reload(true);
                $resultarea.html('');
                get_coursedata(false);

                $coursesearchform.find('.tag-group')
                    .not(':has(label.checkbox)')
                    .addClass('fieldset-hidden');

                $resultarea.toggleClass('section-hidden');
                $tagpreselectarea.toggleClass('section-hidden');
            });
        };

        /**
         * Get the user search criteria.
         */
        var get_user_search_criteria = function () {
            $.when(
                ajax.call([
                    {
                        methodname: 'local_course_search_get_user_search_criteria',
                        args: {
                            userid: userid
                        }
                    }
                ])[0]
            ).then(function (response) {
                var data = JSON.parse(response.data);

                log.debug('get_user_search_criteria');
            });
        };

        /**
         * Get the user search criteria.
         */
        var get_all_course_tags = function () {
            if (preselecttagsloaded) {
                return;
            }

            $.when(
                ajax.call([
                    {
                        methodname: 'local_course_search_get_all_course_tags',
                        args: {
                            userid: userid
                        }
                    }
                ])[0]
            ).then(function (response) {
                var data = JSON.parse(response.data);

                renderTagPreselectArea(data);
            });
        };

        var setCheckboxForPreselectedTags = function () {
            var preselectedtags = getPreselectedCourseTagObjects();

            preselectedtags.forEach(function (tag) {
                $tagpreselectarea
                    .find('[data-id="' + tag.id + '"]')
                    .attr('checked', true);
            });
        };

        return {
            init: function () {
                log.debug('AMD module init.');

                if (cookie.read(cookiename) === null) {
                    cookie.create(cookiename, preselectedtags);
                }

                // Get the relevant DOM elements.
                $catalogarea = $('#catalog-area');
                userid = parseInt($catalogarea.data('userid'), 10);
                $searcharea = $('#search-area');
                $coursesearchform = $('#course-search-form');
                $coursesearchfield = $coursesearchform.find('#course-search');
                $resultarea = $('#result-area');
                $tagpreselectarea = $('#tag-preselect-area');
                $tagarea = $('#tag-area');
                $selectedCourseTags = $tagarea.find('.selected-tags');
                $formsearch = $searcharea.find('.form-search');
                $switchDisplay = $searcharea.find('#switch-display');

                // Get the search data.
                // $.getJSON("./course_search.json", function (data) {
                //     log.debug(data);
                //
                //     grepselectedCourseTags(data);
                //     renderSearchArea(data);
                // }).fail(notification.exception);

                // Get the course data.
                // $.getJSON("./courses.json", function (data) {
                //     log.debug(data);
                //
                //     courses = indexCourseData(data.courses);
                //     data.baseurl = M.cfg.wwwroot;
                //     renderDisplayArea(data);
                // }).fail(notification.exception);
                get_coursedata();

                // Get all available tags.
                // $.getJSON("./fixtures/tags.json", function (response) {
                //     log.debug('tags.json loaded');
                //
                //     renderTagPreselectArea(response);
                // }).fail(notification.exception);
                // get_all_course_tags();

                // Set the event handlers.
                $searcharea.on('change', '[type="checkbox"]', checkboxChangeHandler);
                $searcharea.on('change', 'select', sortSelectHandler);
                $resultarea.on('click', 'th.coltitle', colTitleClickHandler);
                $tagarea.on('click', 'button', selectedTagClickHandler);
                $tagpreselectarea.on('change', '[type="checkbox"]', preselectedCheckboxChangeHandler);
                $tagpreselectarea.on('keyup', '#tagFilter', handleTagFilterText);
                $coursesearchform.on('submit', handleTextSearch);
                $switchDisplay.on('click', handleToggleTagPreselectPage);

                activateDatePicker();

                // get_user_search_criteria();
            }
        };
    }
);


