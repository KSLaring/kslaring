define(["jquery","core/notification","core/log","core/ajax","core/templates","local_course_search/cookie","theme_bootstrapbase/bootstrap"],function($,e,t,a,n,r){"use strict";window.$=$,t.debug("AMD module loaded.");var o="name",i=!0,d=!1,s=!1,c=!1,l=[],u={},f=[],h=0,p=null,g=null,m=null,_=null,v=null,y=null,b=null,C=null,k=null,x=null,w=null,O=!1,q="hide-item",E="preselectedtags",j={id:0,type:null,group:null,name:null},D={id:0,type:null,group:null,name:null,sort:null,pretext:null,posttext:null,remove:0},S={name:"sortorder",date:"sortdate",availseats:"availnumber",deadline:"deadline",municipality:"municipality",location:"location"},J={name:"course_name",date:"course_date",availseats:"course_seats",deadline:"course_deadline",municipality:"course_municipality",location:"course_location"},L=function(e){var t=e.tags.groups,a;t.length&&(t.forEach(function(e){a=$.grep(e.shown,function(e){return 1===e.checked}),a.length&&(l=$.merge(l,a))}),N({selectedCourseTags:l}))},N=function(e){n.render("local_course_search/course_search_selected_tags",e).done(function(e){k.append(e),x=k.find(".selected-tags")})},P=function(e){n.render("local_course_search/course_search_region_search",e).done(function(e){C.after(e),c=!0,W()})},A=function(e){n.render("local_course_search/course_search_result_area",e).done(function(t){e.hasOwnProperty("courses")&&e.courses.length?v.html(t):v.append(t),y=$(".nav-tabs").eq(0),$('a[data-toggle="tab"]').on("shown",se),ne()})},B=function(e){n.render("local_course_search/course_search_tag_preselect_area",e).done(function(e){b.html(e),O=!0,pe()})},H=function(){if(!s&&O){var e=r.read(E),t=[],a=[],n=null;null!==e&&(t=e.split("|"),t.forEach(function(e){a.push(e.split(","))}),n=g.find(".tag-group"),n.length&&n.each(function(e){var t=$(this),n=null,r={};a[e].forEach(function(e){n=b.find('[data-id="'+e+'"]'),n.length&&(n.prop("checked",!0),r=$.extend({},j,{id:n.data("id"),type:n.data("type"),group:n.data("group"),name:n.data("name")}),T(t,r))})})),s=!0}},T=function(e,t){n.render("local_course_search/course_search_region_search_groups_item",t).done(function(t){e.append(t)})},W=function(){require(["local_course_search/Xloader"],function(){$("#date-from").datepicker({format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){F(e)}),$("#date-to").datepicker({format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){F(e)})})},F=function(e){var t=$(e.target),a=t.parents(".date"),r=e.format("yyyymmdd"),o=e.format("dd.mm.yyyy"),i=null,d=$.extend({},D,{type:a.data("type"),group:a.data("group"),name:a.data("name"),posttext:" "+o});t.siblings('input[type="hidden"]').eq(0).val(r),i=k.find("button").filter('[data-name="'+a.data("name")+'"]').parent("li").remove(),""===o?d.remove=1:n.render("local_course_search/course_search_selected_tags_item",d).done(function(e){x.append(e)}),re(),ne()},I=function(){var e=$(this),t=e.parent(),a=e.is(":checked"),r=null,o=$.extend({},D,{id:t.data("id"),type:t.data("type"),group:t.data("group"),name:t.data("name")});a?"sort"===t.data("group")?(r=k.find("button").filter('[data-group="sort"]').parent("li").remove(),o.sort=t.data("sort"),o.name=M.str.local_course_search.sortby+" "+M.str.local_friadmin[J[o.sort]],console.log(e,t),n.render("local_course_search/course_search_selected_tags_item",o).done(function(e){x.append(e)})):n.render("local_course_search/course_search_selected_tags_item",o).done(function(e){x.append(e)}):(r=k.find("button").filter('[data-name="'+e.parent().data("name")+'"]').parent("li").remove(),o.remove=1),"course"===t.data("type")&&re(),ne()},X=function(){var e=$(this),t=e.is(":checked"),a=null,n="",r="",o={};t?(n=e.data("group"),r=n,a=m.find('fieldset[data-group="'+r+'"]'),o=$.extend({},j,{id:e.data("id"),type:e.data("type"),group:e.data("group"),name:e.data("name")}),T(a,o)):m.find('[data-id="'+e.data("id")+'"]').remove()},z=function(){var e=$(this),t=e.find("option:selected").eq(0),a=e.siblings(".hidden").eq(0),n="";n=t.val().toLowerCase(),o!==n&&(o=n,a.data("sort",n),a.find("input").trigger("change"))},G=function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target),a=g.find("#select-sort"),n=a.find("option"),r=a.siblings(".hidden").eq(0),d="";d=t.data("sort"),o===d?(i=!i,g.find('[data-group="sortdesc"]').find("input").click()):o=d,n.find(":selected").prop("selected",!1),n.filter(function(){return $(this).val()===d}).prop("selected",!0),r.data("sort",d),r.find("input").trigger("change")},K=function(){var e=$(this);"searchquery"===e.data("group")?m.find(".search-query").val(""):"date-from"===e.data("group")?($("#date-from").datepicker("update",""),$("#date-from-eurodate").val("")):"date-to"===e.data("group")?($("#date-to").datepicker("update",""),$("#date-to-eurodate").val("")):g.find("label").filter('[data-name="'+e.data("name")+'"]').find("input").prop("checked",!1),e.remove(),"course"===e.data("type")?re():"display"===e.data("type")&&ne()},Q=function(e){var t=null,a="",n=null,r=null;t=$(e.currentTarget),a=t.val().toLowerCase(),n=b.find(".unlist"),r=n.find("label"),r.each(function(){var e=$(this);-1!==e.find("input").data("name").toLowerCase().indexOf(a)?e.parent("li").removeClass("hidden"):e.parent("li").addClass("hidden")}),""!==a?b.find(".accordion-body").each(function(){var e=$(this);e.has("li:not(.hidden)").length?e.collapse("show"):e.collapse("hide")}):b.find(".accordion-body").collapse("hide")},R=function(e){var t=$(this),a,r;e.preventDefault(),a=t.find(".search-query").val(),r=$.extend({},D,{type:"course",group:"searchquery",name:a,pretext:"Search text: "}),k.find("li").has('[data-group="searchquery"]').remove(),""!==a&&n.render("local_course_search/course_search_selected_tags_item",r).done(function(e){x.append(e)}),re()},U=function(){return _.val().toLowerCase()},V=function(){var e,t=[];return e=m.find("label").has(":checked"),e.each(function(){var e=$(this);"course"===e.data("type")&&t.push(e.data("group")+"-"+e.data("name"))}),t},Y=function(){var e,t={};return e=m.find("label").has(":checked"),e.each(function(){var e=$(this);"course"===e.data("type")&&(t.hasOwnProperty(e.data("group"))||(t[e.data("group")]=[]),t[e.data("group")].push(e.data("group")+"-"+e.data("name")))}),t},Z=function(){var e,t=[];return e=m.find("label.checkbox"),e.each(function(){var e=$(this);"course"===e.data("type")&&t.push({id:e.data("id"),type:e.data("type"),name:e.data("name"),group:e.data("group"),groupid:e.data("groupid")})}),t},ee=function(){var e={from:null,to:null,datesset:!1},t;return t=$("#date-from-eurodate").val(),""!==t&&(e.from=t,e.datesset=!0),t=$("#date-to-eurodate").val(),""!==t&&(e.to=t,e.datesset=!0),e},te=function(){var e,t=[];return e=m.find("label").has(":checked"),e.each(function(){var e=$(this);"display"===e.data("type")&&("sort"===e.data("group")?t.push("sort-"+e.data("sort")):t.push(e.data("group")))}),t},ae=function(){var e,t=[];return e=b.find("input:checked"),e.each(function(){t.push($(this).data("id"))}),t},ne=function(){var e=null,t=null,a=te(),n="name",r=null,o=function(e,t){return i?$(t).data(S[n])<$(e).data(S[n])?1:-1:$(t).data(S[n])>$(e).data(S[n])?1:-1};-1!==a.indexOf("tags")?v.find(".course-list").removeClass("tags-hidden"):v.find(".course-list").addClass("tags-hidden"),i=-1===a.indexOf("sortdesc"),a.forEach(function(e){-1!==e.indexOf("sort-")&&(n=e.replace("sort-",""))}),v.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),v.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc"),r=v.find(".course-list-col-titles").find('[data-sort="'+n+'"]'),i?r.addClass("sortasc"):r.addClass("sortdesc"),e=v.find("#tabcards").find(".course-cards").eq(0),e.html(e.children(".course-card-item").sort(o)),e=v.find("#tablist").find(".course-list").find("tbody").eq(0),e.html(e.children(".course-list-item").sort(o)),t=v.find("#tablist").find(".course-list"),t.find("tr:not(.hide-item)").each(function(e){e%2?$(this).removeClass("odd"):$(this).addClass("odd")})},re=function(){var e=Y(),t=U(),a=ee(),n=""!==t,r=oe(f),o=[],i,d=!1;if(!Object.keys(e).length&&""===t&&null===a.from&&null===a.to)return void ie(r);null===a.from&&null===a.to||(o=r.filter(function(e){if(i=u[e],null!==a.from&&null!==a.to){if(i.sortdate>=a.from&&i.sortdate<=a.to)return!0}else if(null!==a.from){if(i.sortdate>=a.from)return!0}else{if(null===a.to)return!1;if(i.sortdate<=a.to)return!0}}),o.length&&(d=!0,r=oe(o),o=[])),n&&(o=r.filter(function(e){return i=u[e],i.hasOwnProperty("alltext")&&i.alltext&&-1!==i.alltext.indexOf(t)}),r=oe(o),o.length?(d=!0,o=[]):d=!1),Object.keys(e).forEach(function(t){o=r.filter(function(a){var n=!1;return e[t].forEach(function(e){-1!==u[a].tagcollection.indexOf(e)&&(n=!0)}),n}),r=oe(o),o.length?(d=!0,o=[]):d=!1}),d||(r=[-1]),ie(r)},oe=function(e){return e.slice(0)},ie=function(e){var t=v.find(".course-cards"),a=v.find(".course-list");e.length?-1===e[0]?f.forEach(function(e){t.find("#coursecarditem-"+e).addClass("hide-item"),a.find("#courselistitem-"+e).addClass("hide-item")}):f.forEach(function(n){-1!==e.indexOf(n)?(t.find("#coursecarditem-"+n).removeClass("hide-item"),a.find("#courselistitem-"+n).removeClass("hide-item")):(t.find("#coursecarditem-"+n).addClass("hide-item"),a.find("#courselistitem-"+n).addClass("hide-item"))}):f.forEach(function(e){t.find("#coursecarditem-"+e).removeClass("hide-item"),a.find("#courselistitem-"+e).removeClass("hide-item")})},de=function(){var e="",t=[],a=null,n,o;d?(w.text(w.data("changetoselection")),v.find('[href="#tablist"]').hasClass("active")&&m.find(".display").find('[data-group="tags"]').removeClass("hidden"),a=g.find(".tag-group"),n=a.length-1,a.length&&a.each(function(a){var r=$(this),i=null;i=r.find(".checkbox"),o=i.length-1,i.length&&i.each(function(a){e+=$(this).data("id"),t.push($(this).data("id")),a<o&&(e+=",")}),a<n&&(e+="|")}),r.create(E,e,14),_.blur(),k.find(".btn-tag").each(function(){$(this).click()}),ue(t)):(d=!d,w.text(w.data("changetoresults")),console.log("showtagliststate",m.find(".display").find('[data-group="tags"]')),m.find(".display").find('[data-group="tags"]').addClass("hidden"),_.blur(),k.find(".btn-tag").each(function(){$(this).click()}),m.find(".fieldset-hidden").removeClass("fieldset-hidden"),v.toggleClass("section-hidden"),b.toggleClass("section-hidden"))},se=function(e){var t=$(e.target).attr("href"),a=m.find(".display").find('[data-group="tags"]'),n=a.find("input");"#tabcards"===t?a.addClass("hidden"):"#tablist"===t&&a.removeClass("hidden")},ce=function(e){var t=[],a=[],n=[];return $.each(e,function(e,r){t=[],a=[],n.push(r.id),$.each(r.tags,function(e,n){a.push(n.group+"-"+n.name),t.push(n.name)}),r.tagcollection=a,r.alltext=t.join(","),r.alltext+=" "+r.name+" "+r.summary,r.alltext=r.alltext.toLowerCase()}),e.courseids=n,e},le=function(){$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:h}}])[0]).then(function(e){var t=JSON.parse(e.coursedata);u=t.courses,f=Object.keys(u),A({courses:f.map(function(e){return u[e]})}),he()})},ue=function(e){var t={sesskey:M.cfg.sesskey,tags:e};$.when(a.call([{methodname:"local_course_search_save_search_criteria",args:{data:JSON.stringify(t)}}])[0]).then(function(e){var t=JSON.parse(e.result);d=!d,v.html(""),le(!1),m.find(".tag-group").not(":has(label.checkbox)").addClass("fieldset-hidden"),v.toggleClass("section-hidden"),b.toggleClass("section-hidden")})},fe=function(){$.when(a.call([{methodname:"local_course_search_get_user_search_criteria",args:{userid:h}}])[0]).then(function(e){var a=JSON.parse(e.data);t.debug("get_user_search_criteria")})},he=function(){O||$.when(a.call([{methodname:"local_course_search_get_all_course_tags",args:{userid:h}}])[0]).then(function(e){var t=JSON.parse(e.data);B(t)})},pe=function(){Z().forEach(function(e){b.find('[data-id="'+e.id+'"]').attr("checked",!0)})};return{init:function(){t.debug("AMD module init."),null===r.read(E)&&r.create(E,"433,430,431,16,39,108,196,268,352|449,452,450,453|458,459|460,462,463"),p=$("#catalog-area"),h=parseInt(p.data("userid"),10),g=$("#search-area"),m=$("#course-search-form"),_=m.find("#course-search"),v=$("#result-area"),b=$("#tag-preselect-area"),k=$("#tag-area"),x=k.find(".selected-tags"),C=g.find(".form-search"),w=g.find("#switch-display"),le(),g.on("change",'[type="checkbox"]',I),g.on("change","select",z),v.on("click","th.coltitle",G),k.on("click","button",K),b.on("change",'[type="checkbox"]',X),b.on("keyup","#tagFilter",Q),m.on("submit",R),w.on("click",de),W()}}});