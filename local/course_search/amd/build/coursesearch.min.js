define(["jquery","core/notification","core/log","core/ajax","core/templates","theme_bootstrapbase/bootstrap","local_course_search/ld_loader","local_course_search/viewstate","local_course_search/is_loader","local_course_search/dp_loader"],function($,e,t,a,s,n,o,i,r){"use strict";if(window.$=$,t.debug("AMD module loaded."),!$("#header").hasClass("not-loggedin")){var d=!1,l=0,c=!0,u="name",f=!0,h=!1,g=0,p=null,m=null,y={},v=[],_=[],b=[],C=12,w=6,x=30,D=15,k=!1,O=!1,S=[],T=[],q=0,I=null,j=null,E=null,P=null,F=null,J=null,N=null,V=null,L=null,B=null,A=null,H=null,W=null,z=null,G=null,K=null,Q=null,R=null,U=null,X=null,Y=null,Z=null,ee=!1,te="hide-item",ae={id:0,type:null,group:null,name:null},se={id:0,type:null,group:null,name:null,sort:null,pretext:null,posttext:null,remove:0},ne={name:"sortorder",date:"sortdate",availseats:"availnumber",deadline:"deadline",municipality:"municipality",location:"location"},oe={name:"course_name",date:"course_date",availseats:"course_seats",deadline:"course_deadline",municipality:"course_municipality",location:"course_location"},ie={view:0,text:1,tags:2,date:3,display:4},re=function(e,t){s.render("local_course_search/course_search_region_search_groups_item",t).done(function(t){e.append(t)})},de=function(e){"0"===i.getView()?pe(12):ye(30)},le=function(e){k=!0,pe(),I=new r(z.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("cardsInfScroll init")}}),fe(!0)},ce=function(e){O=!0,ye(),j=new r(G.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("listInfScroll init")}}),he(!0)},ue=function(e){s.render("local_course_search/course_search_tag_preselect_area",e).done(function(e){Q.html(e),ee=!0,We()})},fe=function(e){I&&(e?I.on("scrollThreshold",ge):I.off("scrollThreshold",ge))},he=function(e){j&&(e?j.on("scrollThreshold",me):j.off("scrollThreshold",me))},ge=function(){if(!S.length)return t.debug("cards all shown"),void fe(!1);t.debug("card more courses"),pe()},pe=function(e){if(1){var t=void 0===e?6:e,a={courses:[]},n=S.splice(0,t);a.courses=n.map(function(e){return y[e]}),a.courses.length&&s.render("local_course_search/course_search_course_card_set",a).done(function(e){z.append(e),ot(z.find(".course-title"))})}},me=function(){if(!T.length)return t.debug("list all shown"),void he(!1);t.debug("list more courses"),ye()},ye=function(e){if(1){var t=void 0===e?15:e,a={courses:[]},n=T.splice(0,t);a.courses=n.map(function(e){return y[e]}),a.courses.length&&s.render("local_course_search/course_search_course_list_set",a).done(function(e){G.children("tbody").append(e),ot(G.find('[data-toggle="tooltip"]'))})}},ve=function(e){var t=$(e.target).attr("href");"#tabcards"===t?(i.setView("0"),ze(),z.children("li").length||pe(12)):"#tablist"===t&&(i.setView("1"),ze(),G.children("tbody").children("tr").length||ye(30))},_e=function(){var e="",t=[],a=null,s,n;h?(Z.text(Z.data("changetoselection")),A.find('[href="#tablist"]').hasClass("active")&&L.find(".display").find('[data-group="tags"]').removeClass("hidden"),a=V.find(".tag-group"),s=a.length-1,a.length&&a.each(function(a){var o=$(this),i=null;i=o.find(".checkbox"),n=i.length-1,i.length&&i.each(function(a){e+=$(this).data("id"),t.push($(this).data("id")),a<n&&(e+=",")}),a<s&&(e+="|")}),B.blur(),X.find(".btn-tag").each(function(){$(this).click()}),st(t)):(h=!h,Z.text(Z.data("changetoresults")),L.find(".display").find('[data-group="tags"]').addClass("hidden"),m.hide(),fe(!1),he(!1),B.blur(),X.find(".btn-tag").each(function(){$(this).click()}),L.find(".fieldset-hidden").removeClass("fieldset-hidden"),A.toggleClass("section-hidden"),Q.toggleClass("section-hidden"))},be=function(e){var t=$(e.target),a=t,s=a.data("group"),n=e.format("yyyymmdd"),o=e.format("yyyy-mm-dd"),r=e.format("dd.mm.yyyy");i.setDate(""===o?"0":o,s),t.siblings('input[type="hidden"]').eq(0).val(n),Ye(-1!==s.indexOf("from")?"from":"to")},Ce=function(){var e=$(this),t=e.parent(),a=e.is(":checked"),s=t.data("id");a?"sort"===t.data("group")?(Ue(".display",s,1),"d0"===s&&i.setDisplay(t.data("sort"),"sort")):"string"==typeof s&&-1!==s.indexOf("d")?(Ue(".display",s,1),i.setDisplay("1","d1"===s?"desc":"showtags"),"d1"===s&&Xe()):(Ue(".tag-group",s,1),i.setTag(s.toString(),"add")):"string"==typeof s&&-1!==s.indexOf("d")?(Ue(".display",s,0),i.setDisplay("0","d1"===s?"desc":"showtags"),"d1"===s&&Xe()):(Ue(".tag-group",s,0),i.setTag(s.toString(),"remove"))},we=function(){var e=U.find("option:selected").eq(0),t=U.siblings(".hidden").eq(0),a=e.val().toLowerCase();t.data("sort",a),i.setDisplay(a,"sort"),Xe()},xe=function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target),a=U.siblings(".hidden").eq(0),s=t.data("sort");i.getDisplaySort()===s?"0"===i.getDisplayDesc()?(i.setDisplay("1","desc"),Ue(".display","d1",1)):(i.setDisplay("0","desc"),Ue(".display","d1",0)):i.setDisplay(s,"sort"),Xe()},De=function(){var e=$(this),t=0;"searchquery"===e.data("group")?(L.find(".search-query").val(""),i.setText("")):"date-from"===e.data("group")?(E.datepicker("update",""),$("#date-from-eurodate").val(""),i.setDate("0","date-from")):"date-to"===e.data("group")?(P.datepicker("update",""),$("#date-to-eurodate").val(""),i.setDate("0","date-to")):"sort"===e.data("group")?(U.val("name"),i.setDisplay("name","sort"),Xe()):"display"===e.data("type")?(t=e.data("id"),V.find("label").filter('[data-id="'+t+'"]').find("input").prop("checked",!1),"d1"===t?(i.setDisplay("0","desc"),Xe()):"d2"===t&&i.setDisplay("0","showtags")):(t=e.data("id"),V.find("label").filter('[data-id="'+t+'"]').find("input").prop("checked",!1),i.setTag(t,"remove")),e.remove(),"sort"===e.data("group")||"course"===e.data("type")||e.data("type")},ke=function(){var e=$(this),t=e.is(":checked"),a=null,s="",n="",o={};t?(s=e.data("group"),n=s,a=L.find('fieldset[data-group="'+n+'"]'),o=$.extend({},ae,{id:e.data("id"),type:e.data("type"),group:e.data("group"),name:e.data("name")}),re(a,o)):L.find('[data-id="'+e.data("id")+'"]').remove()},Oe=function(e){var t=null,a="",s=null,n=null;t=$(e.currentTarget),a=t.val().toLowerCase(),s=Q.find(".unlist"),n=s.find("label"),n.each(function(){var e=$(this);-1!==e.find("input").data("name").toLowerCase().indexOf(a)?e.parent("li").removeClass("hidden"):e.parent("li").addClass("hidden")}),""!==a?Q.find(".accordion-body").each(function(){var e=$(this);e.has("li:not(.hidden)").length?e.collapse("show"):e.collapse("hide")}):Q.find(".accordion-body").collapse("hide")},Se=function(e){var t=$(this),a;e.preventDefault(),a=t.find(".search-query").val(),i.setText(a),Re()},Te=function(){var e,t={};return e=L.find("label").has(":checked"),e.each(function(){var e=$(this);"course"===e.data("type")&&(t.hasOwnProperty(e.data("group"))||(t[e.data("group")]=[]),t[e.data("group")].push(e.data("group")+"-"+e.data("name")))}),t},qe=function(){var e,t=[];return e=L.find("label.checkbox"),e.each(function(){var e=$(this);"course"===e.data("type")&&t.push({id:e.data("id"),type:e.data("type"),name:e.data("name"),group:e.data("group"),groupid:e.data("groupid")})}),t},Ie=function(){var e,t=[];return e=L.find("label").has(":checked"),e.each(function(){var e=$(this);"display"===e.data("type")&&("sort"===e.data("group")?t.push("sort-"+e.data("sort")):t.push(e.data("group")))}),t},je=function(){var e=null,t=null,a=Ie(),s="name",n=null;if(!v.length){var o;for(o in y)y.hasOwnProperty(o)&&v.push({id:y[o].id,sortorder:y[o].sortorder,sortdate:y[o].sortdate,availnumber:y[o].availnumber,deadline:y[o].deadline,municipality:y[o].municipality?y[o].municipality.toLowerCase():"",location:y[o].location?y[o].location.toLowerCase():""})}var i=function(e,t){return f?t[ne[s]]<e[ne[s]]?1:-1:t[ne[s]]>e[ne[s]]?1:-1};-1!==a.indexOf("tags")?A.find(".course-list").removeClass("tags-hidden"):A.find(".course-list").addClass("tags-hidden"),f=-1===a.indexOf("sortdesc"),a.forEach(function(e){-1!==e.indexOf("sort-")&&(s=e.replace("sort-",""))}),A.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),A.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc"),n=A.find(".course-list-col-titles").find('[data-sort="'+s+'"]'),f?n.addClass("sortasc"):n.addClass("sortdesc"),v.sort(i),_=[],v.forEach(function(e){_.push("c"+e.id)}),Pe()},Ee=function(){var e=null,t=null,a=Ie(),s="name",n=null,o=function(e,t){return f?$(t).data(ne[s])<$(e).data(ne[s])?1:-1:$(t).data(ne[s])>$(e).data(ne[s])?1:-1};-1!==a.indexOf("tags")?A.find(".course-list").removeClass("tags-hidden"):A.find(".course-list").addClass("tags-hidden"),f=-1===a.indexOf("sortdesc"),a.forEach(function(e){-1!==e.indexOf("sort-")&&(s=e.replace("sort-",""))}),A.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),A.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc"),n=A.find(".course-list-col-titles").find('[data-sort="'+s+'"]'),f?n.addClass("sortasc"):n.addClass("sortdesc"),e=A.find("#tabcards").find(".course-cards").eq(0),e.html(e.children(".course-card-item").sort(o)),e=A.find("#tablist").find(".course-list").find("tbody").eq(0),e.html(e.children(".course-list-item").sort(o)),t=A.find("#tablist").find(".course-list"),t.find("tr:not(.hide-item)").each(function(e){e%2?$(this).removeClass("odd"):$(this).addClass("odd")})},Pe=function(){return t.debug("enter filterCourses"),new Promise(function(e,t){var a=Te(),s=i.getText(),n=i.getFromDate(),o=0,r=i.getToDate(),d=0,l=""!==i.getText(),c=[],u,f,h=!1;if(b=_.slice(),!Object.keys(a).length&&!l&&"0"===n&&"0"===r)return void e(b);"0"===n&&"0"===r||(console.log(n,r),o=parseInt(n.replace(/-/g,""),10),d=parseInt(r.replace(/-/g,""),10),c=b.filter(function(e){if(u=y[e],f=parseInt(u.sortdate,10),o&&d){if(f>=o&&f<=d)return!0}else if(o){if(f>=o)return!0}else{if(!d)return!1;if(f<=d)return!0}}),c.length&&(h=!0,b=c.slice(),c=[])),l&&(c=b.filter(function(e){return u=y[e],u.hasOwnProperty("alltext")&&u.alltext&&-1!==u.alltext.indexOf(s)}),b=c.slice(),c.length?(h=!0,c=[]):h=!1),Object.keys(a).forEach(function(e){c=b.filter(function(t){var s=!1;return a[e].forEach(function(e){-1!==y[t].tagcollection.indexOf(e)&&(s=!0)}),s}),b=c.slice(),c.length?(h=!0,c=[]):h=!1}),h||(b=[-1]),e(b)})},Me=function(e){return t.debug("enter sortFilteredCourses"),new Promise(function(t,a){t(o.chain(o.values(y)).filter(function(t){return-1!==e.indexOf("c"+t.id)}).orderBy(ne[i.getDisplaySort()],"0"===i.getDisplayDesc()?"asc":"desc").flatMap(function(e){return"c"+e.id}).value())})},Fe=function(e){return t.debug("enter showFilteredCourses"),new Promise(function(t,a){var n,o;z.html(""),G&&G.children("tbody").html(""),e.length&&-1!==e[0]?(S=e.slice(),T=e.slice(),g=e.length,p.text(g),n={courses:[]},"0"===i.getView()?(o=S.splice(0,12),n.courses=o.map(function(e){return y[e]}),n.courses.length&&s.render("local_course_search/course_search_course_card_set",n).done(function(e){z.html(e),ot(z.find(".course-title")),fe(!0)})):"1"===i.getView()&&(o=T.splice(0,30),n.courses=o.map(function(e){return y[e]}),n.courses.length&&s.render("local_course_search/course_search_course_list_set",n).done(function(e){G.children("tbody").html(e),ot(G.find('[data-toggle="tooltip"]')),he(!0)}))):(S=[],T=[],g=0,p.text(g)),t(e)})},Je=function(e){var t=A.find(".course-cards"),a=A.find(".course-list");e.length?-1===e[0]?_.forEach(function(e){t.find("#coursecarditem-"+e).addClass("hide-item"),a.find("#courselistitem-"+e).addClass("hide-item")}):_.forEach(function(s){-1!==e.indexOf(s)?(t.find("#coursecarditem-"+s).removeClass("hide-item"),a.find("#courselistitem-"+s).removeClass("hide-item")):(t.find("#coursecarditem-"+s).addClass("hide-item"),a.find("#courselistitem-"+s).addClass("hide-item"))}):_.forEach(function(e){t.find("#coursecarditem-"+e).removeClass("hide-item"),a.find("#courselistitem-"+e).removeClass("hide-item")})},Ne=function(){return t.debug("enter getCoursedata"),new Promise(function(e,t){if(!1)return void e(!1);$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:q,nocache:parseInt(l,10)}}])[0]).then(function(t){var a=JSON.parse(t.coursedata);y=a.courses,_=Object.keys(y),b=_.slice(),S=_.slice(),T=_.slice(),g=_.length,p.text(g),m.show(),g&&A.find(".alert-info").remove(),console.log("courses",y),console.log("courseids",_.slice()),e(!0)})})},Ve=function(){$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:q}}])[0]).then(function(e){var t=JSON.parse(e.coursedata),a=[];s.render("local_course_search/course_search_course_list",{}),y=t.courses,_=Object.keys(y),S=_.slice(),T=_.slice(),g=_.length,p.text(g),m.show(),console.log("courses",y),console.log("courseids",_.slice()),a=S.splice(0,12),de({courses:a.map(function(e){return y[e]})}),He()})},Le=function(){$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:q}}])[0]).then(function(e){var t=JSON.parse(e.coursedata),a={},s=[];y=t.courses,v=[],_=Object.keys(y),S=_.slice(),T=_.slice(),g=_.length,p.text(g),m.show(),console.log("changed courses",y),console.log("changed courseids",_.slice()),fe(!0),pe(12)})},Be=function(e){return t.debug("enter saveInterests"),new Promise(function(t,s){var n={sesskey:M.cfg.sesskey,tags:e};$.when(a.call([{methodname:"local_course_search_save_search_criteria",args:{data:JSON.stringify(n)}}])[0]).then(function(e){var a=JSON.parse(e.result);h=!h,z.html(""),G&&G.children("tbody").html(""),L.find(".tag-group").not(":has(label.checkbox)").addClass("fieldset-hidden"),A.toggleClass("section-hidden"),Q.toggleClass("section-hidden"),t(!0)})})},Ae=function(){$.when(a.call([{methodname:"local_course_search_get_user_search_criteria",args:{userid:q}}])[0]).then(function(e){var a=JSON.parse(e.data);t.debug("get_user_search_criteria")})},He=function(){ee||$.when(a.call([{methodname:"local_course_search_get_all_course_tags",args:{userid:q}}])[0]).then(function(e){var t=JSON.parse(e.data);ue(t)})},We=function(){qe().forEach(function(e){Q.find('[data-id="'+e.id+'"]').attr("checked",!0)})},$e=function(e){require(["javascript/locales/bootstrap-datepicker.no","javascript/locales/bootstrap-datepicker.de"],function(){E.datepicker({language:e,format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){be(e)}),P.datepicker({language:e,format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){be(e)})})},ze=function(){var e=L.find(".display").find('[data-group="tags"]');K.find(".active").removeClass("active"),"0"===i.getView()?(t.debug("Show cards view"),e.addClass("hidden"),Ke(0),Ge(1)):"1"===i.getView()&&(t.debug("Show list view"),e.removeClass("hidden"),Ge(0),Ke(1))},Ge=function(e){e?(K.find('a[href="#tabcards"]').parent("li").addClass("active"),H.addClass("active"),fe(!0)):(H.removeClass("active"),fe(!1))},Ke=function(e){e?(K.find('a[href="#tablist"]').parent("li").addClass("active"),W.addClass("active"),he(!0)):(W.removeClass("active"),he(!1))},Qe=function(e,t){""!==e&&X.find("li").has(e).remove(),o.isObject(t)&&s.render("local_course_search/course_search_selected_tags_item",t).done(function(e){Y.append(e)})},Re=function(){var e=i.getText(),t;""!==e&&(t=$.extend({},se,{type:"course",group:"searchquery",name:e,pretext:M.str.local_course_search.searchtext})),Qe('[data-group="searchquery"]',t)},Ue=function(e,t,a){var s=L.find(e).find('.checkbox[data-id="'+t+'"]'),n="",o=null;a?(s.find("input").prop("checked",!0),o=$.extend({},se,{id:s.data("id"),type:s.data("type"),group:s.data("group"),name:s.data("name")}),"sort"===s.data("group")&&(o.sort=s.data("sort"),o.name=M.str.local_course_search.sortby+" "+M.str.local_friadmin[oe[o.sort]],n='[data-group="sort"]'),Qe(n,o)):(s.find("input").prop("checked",!1),Qe('[data-id="'+s.data("id")+'"]',o))},Xe=function(){var e;U.val(i.getDisplaySort()),U.siblings(".hidden").eq(0).data("sort",i.getDisplaySort()),A.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),A.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc");var t=A.find(".course-list-col-titles").find('[data-sort="'+i.getDisplaySort()+'"]');"0"===i.getDisplayDesc()?t.addClass("sortasc"):t.addClass("sortdesc"),e=$.extend({},se,{id:"d0",type:"display",group:"sort",sort:i.getDisplaySort(),name:M.str.local_course_search.sortby+" "+M.str.local_friadmin[oe[i.getDisplaySort()]]}),Qe('[data-id="'+e.id+'"]',e)},Ye=function(e){var t="0",a="",s="",n=null;"from"===e?t=i.getFromDate():"to"===e&&(t=i.getToDate()),"0"!==t?("from"===e?(s=F.siblings('input[type="hidden"]').eq(0).val(),a=E.data("name")):"to"===e&&(s=J.siblings('input[type="hidden"]').eq(0).val(),a=P.data("name")),n=$.extend({},se,{id:"date-"+e,type:"course",group:"date-"+e,name:a,posttext:" "+s}),Qe('[data-id="date-'+e+'"]',n)):Qe('[data-id="date-'+e+'"]',null)},Ze=function(){"1"===i.getDisplayShowtags()?A.find(".course-list").removeClass("tags-hidden"):A.find(".course-list").addClass("tags-hidden")},et=function(){Pe().then(Me).then(Fe)},tt=function(){Ne().then(function(e){e&&et()})},at=function(){Ne().then(function(e){He(),e&&et()})},st=function(e){Be(e).then(Ne).then(function(e){e&&et()})},nt=function(){var e,a=[];if(ze(),""!==i.getText()){var s=i.getText();t.debug("Set search text to: "+s),B.val(s),Re()}t.debug("Check tags: "),t.debug(i.getTags()),i.getTags().forEach(function(e){""!==e&&(L.find(".checkbox").filter('[data-id="'+e+'"]').length?Ue(".tag-group",e,1):a.push(e))}),a.length&&i.removeTags(a),"0"!==i.getFromDate()&&o.delay(function(){E.datepicker("update",i.getFromDate().split("-").reverse().join(".")),Ye("from")},500),"0"!==i.getToDate()&&o.delay(function(){P.datepicker("update",i.getToDate().split("-").reverse().join(".")),Ye("to")},500),"1"===i.getDisplayDesc()&&Ue(".display","d1",1),Xe(),"1"===i.getDisplayShowtags()&&Ue(".display","d2",1),Ze()},ot=function(e){c||e.tooltip({delay:{show:300,hide:100}})};return{init:function(e,a,s){t.debug("AMD module init with lang "+e),l=s,c=a,i.init(),p=$("#actualCourseCount"),m=$("#actualCourseCountInfo"),N=$("#catalog-area"),q=parseInt(N.data("userid"),10),L=$("#course-search-form"),B=L.find("#course-search"),V=$("#search-area"),R=V.find(".form-search"),U=V.find("#select-sort"),F=$("#date-from"),E=F.parents('[data-group="date-from"]'),J=$("#date-to"),P=J.parents('[data-group="date-to"]'),Z=V.find("#switch-display"),A=$("#result-area"),K=A.find(".nav-tabs").eq(0),H=A.find("#tabcards"),W=A.find("#tablist"),z=A.find("#course-cards"),G=A.find("#course-list"),X=$("#tag-area"),Y=X.find(".selected-tags"),Q=$("#tag-preselect-area"),L.on("submit",Se),V.on("change",'[type="checkbox"]',Ce),V.on("change","#select-sort",we),A.on("shown",'a[data-toggle="tab"]',ve),A.on("click","th.coltitle",xe),X.on("click","button",De),Q.on("change",'[type="checkbox"]',ke),Q.on("keyup","#tagFilter",Oe),Z.on("click",_e),I=new r(z.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("cardsInfScroll init")}}),j=new r(G.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("listInfScroll init")}}),$("body").on("viewstate:change",function(e,a){t.debug("coursesearch:change",a),"view"===a||("showtags"===a?Ze():"sort"===a||"desc"===a?Me(b).then(Fe):et())}),$e(e),nt(),window.Promise?at():require(["javascript/promise.min"],function(){at()})}}}});