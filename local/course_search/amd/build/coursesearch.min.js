define(["jquery","core/notification","core/log","core/ajax","core/templates","theme_bootstrapbase/bootstrap","local_course_search/ld_loader","local_course_search/viewstate","local_course_search/is_loader","local_course_search/dp_loader"],function($,e,t,a,n,o,s,r,i){"use strict";if(t.debug("AMD module loaded."),!$("#header").hasClass("not-loggedin")){var d=!1,l=0,c=!0,u="name",f=!0,h=!1,g=0,p=null,y=null,m={},v=[],_=[],b=[],w=12,D=6,x=30,C=15,k=!1,S=!1,T=[],O=[],q=0,j=null,I=null,P=null,F=null,V=null,E=null,J=null,L=null,N=null,B=null,W=null,A=null,H=null,z=null,G=null,K=null,Q=null,R=null,U=null,X=null,Y=null,Z=null,ee=!1,te="hide-item",ae={id:0,type:null,group:null,name:null},ne={id:0,type:null,group:null,name:null,sort:null,pretext:null,posttext:null,remove:0},oe={name:"sortorder",date:"sortdate",availseats:"availnumber",deadline:"deadline",municipality:"municipality",location:"location"},se={name:"course_name",date:"course_date",availseats:"course_seats",deadline:"course_deadline",municipality:"course_municipality",location:"course_location"},re={view:0,text:1,tags:2,date:3,display:4},ie=function(e,t){n.render("local_course_search/course_search_region_search_groups_item",t).done(function(t){e.append(t)})},de=function(e){"0"===r.getView()?he(12):pe(30)},le=function(e){n.render("local_course_search/course_search_tag_preselect_area",e).done(function(e){Q.html(e),ee=!0,Ve()})},ce=function(e){j&&(e?j.on("scrollThreshold",fe):j.off("scrollThreshold",fe))},ue=function(e){I&&(e?I.on("scrollThreshold",ge):I.off("scrollThreshold",ge))},fe=function(){if(!T.length)return t.debug("cards all shown"),void ce(!1);t.debug("card more courses"),he()},he=function(e){if(1){var t=void 0===e?6:e,a={courses:[]},o=T.splice(0,t);a.courses=o.map(function(e){return m[e]}),a.courses.length&&n.render("local_course_search/course_search_course_card_set",a).done(function(e){z.append(e),Ye(z.find(".course-title"))})}},ge=function(){if(!O.length)return t.debug("list all shown"),void ue(!1);t.debug("list more courses"),pe()},pe=function(e){if(1){var t=void 0===e?15:e,a={courses:[]},o=O.splice(0,t);a.courses=o.map(function(e){return m[e]}),a.courses.length&&n.render("local_course_search/course_search_course_list_set",a).done(function(e){G.children("tbody").append(e),Ye(G.find('[data-toggle="tooltip"]'))})}},ye=function(e){var t=$(e.target).attr("href");"#tabcards"===t?(r.setView("0"),Je(),z.children("li").length||he(12)):"#tablist"===t&&(r.setView("1"),Je(),G.children("tbody").children("tr").length||pe(30))},me=function(){var e="",t=[],a=null,n,o;h?(Z.text(Z.data("changetoselection")),W.find('[href="#tablist"]').hasClass("active")&&N.find(".display").find('[data-group="tags"]').removeClass("hidden"),a=L.find(".tag-group"),n=a.length-1,a.length&&a.each(function(a){var s=$(this),r=null;r=s.find(".checkbox"),o=r.length-1,r.length&&r.each(function(a){e+=$(this).data("id"),t.push($(this).data("id")),a<o&&(e+=",")}),a<n&&(e+="|")}),B.blur(),X.find(".btn-tag").each(function(){$(this).click()}),Ue(t)):(h=!h,Z.text(Z.data("changetoresults")),N.find(".display").find('[data-group="tags"]').addClass("hidden"),y.hide(),ce(!1),ue(!1),B.blur(),X.find(".btn-tag").each(function(){$(this).click()}),N.find(".fieldset-hidden").removeClass("fieldset-hidden"),W.toggleClass("section-hidden"),Q.toggleClass("section-hidden"))},ve=function(e){var t=$(e.target),a=t,n=a.data("group"),o=e.format("yyyymmdd"),s=e.format("yyyy-mm-dd"),i=e.format("dd.mm.yyyy");r.setDate(""===s?"0":s,n),t.siblings('input[type="hidden"]').eq(0).val(o),ze(-1!==n.indexOf("from")?"from":"to")},_e=function(){var e=$(this),t=e.parent(),a=e.is(":checked"),n=t.data("id");a?"sort"===t.data("group")?(Ae(".display",n,1),"d0"===n&&r.setDisplay(t.data("sort"),"sort")):"string"==typeof n&&-1!==n.indexOf("d")?(Ae(".display",n,1),r.setDisplay("1","d1"===n?"desc":"showtags"),"d1"===n&&He()):(Ae(".tag-group",n,1),r.setTag(n.toString(),"add")):"string"==typeof n&&-1!==n.indexOf("d")?(Ae(".display",n,0),r.setDisplay("0","d1"===n?"desc":"showtags"),"d1"===n&&He()):(Ae(".tag-group",n,0),r.setTag(n.toString(),"remove"))},be=function(){var e=U.find("option:selected").eq(0),t=U.siblings(".hidden").eq(0),a=e.val().toLowerCase();t.data("sort",a),r.setDisplay(a,"sort"),He()},we=function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target),a=U.siblings(".hidden").eq(0),n=t.data("sort");r.getDisplaySort()===n?"0"===r.getDisplayDesc()?(r.setDisplay("1","desc"),Ae(".display","d1",1)):(r.setDisplay("0","desc"),Ae(".display","d1",0)):r.setDisplay(n,"sort"),He()},De=function(){var e=$(this),t=0;"searchquery"===e.data("group")?(N.find(".search-query").val(""),r.setText("")):"date-from"===e.data("group")?(P.datepicker("update",""),$("#date-from-eurodate").val(""),r.setDate("0","date-from")):"date-to"===e.data("group")?(F.datepicker("update",""),$("#date-to-eurodate").val(""),r.setDate("0","date-to")):"sort"===e.data("group")?(U.val("name"),r.setDisplay("name","sort"),He()):"display"===e.data("type")?(t=e.data("id"),L.find("label").filter('[data-id="'+t+'"]').find("input").prop("checked",!1),"d1"===t?(r.setDisplay("0","desc"),He()):"d2"===t&&r.setDisplay("0","showtags")):(t=e.data("id"),L.find("label").filter('[data-id="'+t+'"]').find("input").prop("checked",!1),r.setTag(t,"remove")),e.remove()},xe=function(){var e=$(this),t=e.is(":checked"),a=null,n="",o="",s={};t?(n=e.data("group"),o=n,a=N.find('fieldset[data-group="'+o+'"]'),s=$.extend({},ae,{id:e.data("id"),type:e.data("type"),group:e.data("group"),name:e.data("name")}),ie(a,s)):N.find('[data-id="'+e.data("id")+'"]').remove()},Ce=function(e){var t=null,a="",n=null,o=null;t=$(e.currentTarget),a=t.val().toLowerCase(),n=Q.find(".unlist"),o=n.find("label"),o.each(function(){var e=$(this);-1!==e.find("input").data("name").toLowerCase().indexOf(a)?e.parent("li").removeClass("hidden"):e.parent("li").addClass("hidden")}),""!==a?Q.find(".accordion-body").each(function(){var e=$(this);e.has("li:not(.hidden)").length?e.collapse("show"):e.collapse("hide")}):Q.find(".accordion-body").collapse("hide")},ke=function(e){var t=$(this),a;e.preventDefault(),a=t.find(".search-query").val(),r.setText(a),We()},Se=function(){var e,t={};return e=N.find("label").has(":checked"),e.each(function(){var e=$(this);"course"===e.data("type")&&(t.hasOwnProperty(e.data("group"))||(t[e.data("group")]=[]),t[e.data("group")].push(e.data("group")+"-"+e.data("name")))}),t},Te=function(){var e,t=[];return e=N.find("label.checkbox"),e.each(function(){var e=$(this);"course"===e.data("type")&&t.push({id:e.data("id"),type:e.data("type"),name:e.data("name"),group:e.data("group"),groupid:e.data("groupid")})}),t},Oe=function(){var e,t=[];return e=N.find("label").has(":checked"),e.each(function(){var e=$(this);"display"===e.data("type")&&("sort"===e.data("group")?t.push("sort-"+e.data("sort")):t.push(e.data("group")))}),t},qe=function(){return t.debug("enter filterCourses"),new Promise(function(e,t){var a=Se(),n=r.getText(),o=s.words(n.toLowerCase(),/[^\W]+/g),i=r.getFromDate(),d=0,l=r.getToDate(),c=0,u=o.length,f=[],h,g,p=!1;if(b=_.slice(),!Object.keys(a).length&&!u&&"0"===i&&"0"===l)return void e(b);"0"===i&&"0"===l||(console.log(i,l),d=parseInt(i.replace(/-/g,""),10),c=parseInt(l.replace(/-/g,""),10),f=b.filter(function(e){if(h=m[e],g=parseInt(h.sortdate,10),d&&c){if(g>=d&&g<=c)return!0}else if(d){if(g>=d)return!0}else{if(!c)return!1;if(g<=c)return!0}}),f.length&&(p=!0,b=f.slice(),f=[])),u&&(f=b.filter(function(e){return h=m[e],h.hasOwnProperty("alltext")&&h.alltext&&s.every(o,function(e){return-1!==h.alltext.indexOf(e)})}),b=f.slice(),f.length?(p=!0,f=[]):p=!1),Object.keys(a).forEach(function(e){f=b.filter(function(t){var n=!1;return a[e].forEach(function(e){-1!==m[t].tagcollection.indexOf(e)&&(n=!0)}),n}),b=f.slice(),f.length?(p=!0,f=[]):p=!1}),p||(b=[-1]),e(b)})},je=function(e){return t.debug("enter sortFilteredCourses"),new Promise(function(t,a){t(s.chain(s.values(m)).filter(function(t){return-1!==e.indexOf("c"+t.id)}).orderBy(oe[r.getDisplaySort()],"0"===r.getDisplayDesc()?"asc":"desc").flatMap(function(e){return"c"+e.id}).value())})},Ie=function(e){return t.debug("enter showFilteredCourses"),new Promise(function(t,a){var o,s;z.html(""),G&&G.children("tbody").html(""),e.length&&-1!==e[0]?(T=e.slice(),O=e.slice(),g=e.length,p.text(g),o={courses:[]},"0"===r.getView()?(s=T.splice(0,12),o.courses=s.map(function(e){return m[e]}),o.courses.length&&n.render("local_course_search/course_search_course_card_set",o).done(function(e){z.html(e),Ye(z.find(".course-title")),ce(!0)})):"1"===r.getView()&&(s=O.splice(0,30),o.courses=s.map(function(e){return m[e]}),o.courses.length&&n.render("local_course_search/course_search_course_list_set",o).done(function(e){G.children("tbody").html(e),Ye(G.find('[data-toggle="tooltip"]')),ue(!0)}))):(T=[],O=[],g=0,p.text(g)),t(e)})},Me=function(){return t.debug("enter getCoursedata"),new Promise(function(e,t){if(!1)return void e(!1);$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:q,nocache:parseInt(l,10)}}])[0]).then(function(t){var a=JSON.parse(t.coursedata);m=a.courses,_=Object.keys(m),b=_.slice(),T=_.slice(),O=_.slice(),g=_.length,p.text(g),y.show(),g&&W.find(".alert-info").remove(),console.log("courses",m),console.log("courseids",_.slice()),e(!0)})})},Pe=function(e){return t.debug("enter saveInterests"),new Promise(function(t,n){var o={sesskey:M.cfg.sesskey,tags:e};$.when(a.call([{methodname:"local_course_search_save_search_criteria",args:{data:JSON.stringify(o)}}])[0]).then(function(e){var a=JSON.parse(e.result);h=!h,z.html(""),G&&G.children("tbody").html(""),N.find(".tag-group").not(":has(label.checkbox)").addClass("fieldset-hidden"),W.toggleClass("section-hidden"),Q.toggleClass("section-hidden"),t(!0)})})},Fe=function(){ee||$.when(a.call([{methodname:"local_course_search_get_all_course_tags",args:{userid:q}}])[0]).then(function(e){var t=JSON.parse(e.data);le(t)})},Ve=function(){Te().forEach(function(e){Q.find('[data-id="'+e.id+'"]').attr("checked",!0)})},Ee=function(e){require(["javascript/locales/bootstrap-datepicker.no","javascript/locales/bootstrap-datepicker.de"],function(){P.datepicker({language:e,format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){ve(e)}),F.datepicker({language:e,format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){ve(e)})})},Je=function(){var e=N.find(".display").find('[data-group="tags"]');K.find(".active").removeClass("active"),"0"===r.getView()?(t.debug("Show cards view"),e.addClass("hidden"),Ne(0),Le(1)):"1"===r.getView()&&(t.debug("Show list view"),e.removeClass("hidden"),Le(0),Ne(1))},Le=function(e){e?(K.find('a[href="#tabcards"]').parent("li").addClass("active"),A.addClass("active"),ce(!0)):(A.removeClass("active"),ce(!1))},Ne=function(e){e?(K.find('a[href="#tablist"]').parent("li").addClass("active"),H.addClass("active"),ue(!0)):(H.removeClass("active"),ue(!1))},Be=function(e,t){""!==e&&X.find("li").has(e).remove(),s.isObject(t)&&n.render("local_course_search/course_search_selected_tags_item",t).done(function(e){Y.append(e)})},We=function(){var e=r.getText(),t;""!==e&&(t=$.extend({},ne,{type:"course",group:"searchquery",name:e,pretext:M.str.local_course_search.searchtext})),Be('[data-group="searchquery"]',t)},Ae=function(e,t,a){var n=N.find(e).find('.checkbox[data-id="'+t+'"]'),o="",s=null;a?(n.find("input").prop("checked",!0),s=$.extend({},ne,{id:n.data("id"),type:n.data("type"),group:n.data("group"),name:n.data("name")}),"sort"===n.data("group")&&(s.sort=n.data("sort"),s.name=M.str.local_course_search.sortby+" "+M.str.local_friadmin[se[s.sort]],o='[data-group="sort"]'),Be(o,s)):(n.find("input").prop("checked",!1),Be('[data-id="'+n.data("id")+'"]',s))},He=function(){var e;U.val(r.getDisplaySort()),U.siblings(".hidden").eq(0).data("sort",r.getDisplaySort()),W.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),W.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc");var t=W.find(".course-list-col-titles").find('[data-sort="'+r.getDisplaySort()+'"]');"0"===r.getDisplayDesc()?t.addClass("sortasc"):t.addClass("sortdesc"),e=$.extend({},ne,{id:"d0",type:"display",group:"sort",sort:r.getDisplaySort(),name:M.str.local_course_search.sortby+" "+M.str.local_friadmin[se[r.getDisplaySort()]]}),Be('[data-id="'+e.id+'"]',e)},ze=function(e){var t="0",a="",n="",o=null;"from"===e?t=r.getFromDate():"to"===e&&(t=r.getToDate()),"0"!==t?("from"===e?(n=V.siblings('input[type="hidden"]').eq(0).val(),a=P.data("name")):"to"===e&&(n=E.siblings('input[type="hidden"]').eq(0).val(),a=F.data("name")),o=$.extend({},ne,{id:"date-"+e,type:"course",group:"date-"+e,name:a,posttext:" "+n}),Be('[data-id="date-'+e+'"]',o)):Be('[data-id="date-'+e+'"]',null)},Ge=function(){"1"===r.getDisplayShowtags()?W.find(".course-list").removeClass("tags-hidden"):W.find(".course-list").addClass("tags-hidden")},Ke=function(){qe().then(je).then(Ie)},Qe=function(){Me().then(function(e){e&&Ke()})},Re=function(){Me().then(function(e){Fe(),e&&Ke()})},Ue=function(e){Pe(e).then(Me).then(function(e){e&&Ke()})},Xe=function(){var e,a=[];if(Je(),""!==r.getText()){var n=r.getText();t.debug("Set search text to: "+n),B.val(n),We()}t.debug("Check tags: "),t.debug(r.getTags()),r.getTags().forEach(function(e){""!==e&&(N.find(".checkbox").filter('[data-id="'+e+'"]').length?Ae(".tag-group",e,1):a.push(e))}),a.length&&r.removeTags(a),"0"!==r.getFromDate()&&s.delay(function(){P.datepicker("update",r.getFromDate().split("-").reverse().join(".")),ze("from")},500),"0"!==r.getToDate()&&s.delay(function(){F.datepicker("update",r.getToDate().split("-").reverse().join(".")),ze("to")},500),"1"===r.getDisplayDesc()&&Ae(".display","d1",1),He(),"1"===r.getDisplayShowtags()&&Ae(".display","d2",1),Ge()},Ye=function(e){c||e.tooltip({delay:{show:300,hide:100}})};return{init:function(e,a,n){t.debug("AMD module init with lang "+e),l=n,c=a,r.init(),p=$("#actualCourseCount"),y=$("#actualCourseCountInfo"),J=$("#catalog-area"),q=parseInt(J.data("userid"),10),N=$("#course-search-form"),B=N.find("#course-search"),L=$("#search-area"),R=L.find(".form-search"),U=L.find("#select-sort"),V=$("#date-from"),P=V.parents('[data-group="date-from"]'),E=$("#date-to"),F=E.parents('[data-group="date-to"]'),Z=L.find("#switch-display"),W=$("#result-area"),K=W.find(".nav-tabs").eq(0),A=W.find("#tabcards"),H=W.find("#tablist"),z=W.find("#course-cards"),G=W.find("#course-list"),X=$("#tag-area"),Y=X.find(".selected-tags"),Q=$("#tag-preselect-area"),N.on("submit",ke),L.on("change",'[type="checkbox"]',_e),L.on("change","#select-sort",be),W.on("shown",'a[data-toggle="tab"]',ye),W.on("click","th.coltitle",we),X.on("click","button",De),Q.on("change",'[type="checkbox"]',xe),Q.on("keyup","#tagFilter",Ce),Z.on("click",me),j=new i(z.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("cardsInfScroll init")}}),I=new i(G.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("listInfScroll init")}}),$("body").on("viewstate:change",function(e,a){t.debug("coursesearch:change",a),"view"===a||("showtags"===a?Ge():"sort"===a||"desc"===a?je(b).then(Ie):Ke())}),Ee(e),Xe(),window.Promise?Re():require(["javascript/promise.min"],function(){Re()})}}}});