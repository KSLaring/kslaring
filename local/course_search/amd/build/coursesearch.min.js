define(["jquery","core/notification","core/log","core/ajax","core/templates","theme_bootstrapbase/bootstrap","local_course_search/ld_loader","local_course_search/viewstate","local_course_search/is_loader","local_course_search/dp_loader"],function($,e,t,a,s,n,o,i,r){"use strict";if(window.$=$,t.debug("AMD module loaded."),!$("#header").hasClass("not-loggedin")){var d=!1,c=0,l="name",u=!0,f=!1,h=0,g=null,p=null,m={},y=[],v=[],_=[],b=12,C=6,w=30,x=15,D=!1,k=!1,O=[],S=[],T=0,q=null,I=null,j=null,E=null,P=null,F=null,J=null,N=null,V=null,L=null,B=null,A=null,H=null,W=null,z=null,G=null,K=null,Q=null,R=null,U=null,X=null,Y=null,Z=!1,ee="hide-item",te={id:0,type:null,group:null,name:null},ae={id:0,type:null,group:null,name:null,sort:null,pretext:null,posttext:null,remove:0},se={name:"sortorder",date:"sortdate",availseats:"availnumber",deadline:"deadline",municipality:"municipality",location:"location"},ne={name:"course_name",date:"course_date",availseats:"course_seats",deadline:"course_deadline",municipality:"course_municipality",location:"course_location"},oe={view:0,text:1,tags:2,date:3,display:4},ie=function(e,t){s.render("local_course_search/course_search_region_search_groups_item",t).done(function(t){e.append(t)})},re=function(e){"0"===i.getView()?ge(12):me(30)},de=function(e){D=!0,ge(),q=new r(W.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("cardsInfScroll init")}}),ue(!0)},ce=function(e){k=!0,me(),I=new r(z.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("listInfScroll init")}}),fe(!0)},le=function(e){s.render("local_course_search/course_search_tag_preselect_area",e).done(function(e){K.html(e),Z=!0,He()})},ue=function(e){q&&(e?q.on("scrollThreshold",he):q.off("scrollThreshold",he))},fe=function(e){I&&(e?I.on("scrollThreshold",pe):I.off("scrollThreshold",pe))},he=function(){if(!O.length)return t.debug("card all shown"),void ue(!1);t.debug("card more courses"),ge()},ge=function(e){if(1){var t=void 0===e?6:e,a={courses:[]},n=O.splice(0,t);a.courses=n.map(function(e){return m[e]}),a.courses.length&&s.render("local_course_search/course_search_course_card_set",a).done(function(e){W.append(e)})}},pe=function(){if(!S.length)return t.debug("list all shown"),void fe(!1);t.debug("list more courses"),me()},me=function(e){if(1){var t=void 0===e?15:e,a={courses:[]},n=S.splice(0,t);a.courses=n.map(function(e){return m[e]}),a.courses.length&&s.render("local_course_search/course_search_course_list_set",a).done(function(e){z.children("tbody").append(e)})}},ye=function(e){var t=$(e.target).attr("href");"#tabcards"===t?(i.setView("0"),$e(),W.children("li").length||ge(12)):"#tablist"===t&&(i.setView("1"),$e(),z.children("tbody").children("tr").length||me(30))},ve=function(){var e="",t=[],a=null,s,n;f?(Y.text(Y.data("changetoselection")),B.find('[href="#tablist"]').hasClass("active")&&V.find(".display").find('[data-group="tags"]').removeClass("hidden"),a=N.find(".tag-group"),s=a.length-1,a.length&&a.each(function(a){var o=$(this),i=null;i=o.find(".checkbox"),n=i.length-1,i.length&&i.each(function(a){e+=$(this).data("id"),t.push($(this).data("id")),a<n&&(e+=",")}),a<s&&(e+="|")}),L.blur(),U.find(".btn-tag").each(function(){$(this).click()}),at(t)):(f=!f,Y.text(Y.data("changetoresults")),V.find(".display").find('[data-group="tags"]').addClass("hidden"),p.hide(),ue(!1),fe(!1),L.blur(),U.find(".btn-tag").each(function(){$(this).click()}),V.find(".fieldset-hidden").removeClass("fieldset-hidden"),B.toggleClass("section-hidden"),K.toggleClass("section-hidden"))},_e=function(e){var t=$(e.target),a=t,s=a.data("group"),n=e.format("yyyymmdd"),o=e.format("yyyy-mm-dd"),r=e.format("dd.mm.yyyy");i.setDate(""===o?"0":o,s),t.siblings('input[type="hidden"]').eq(0).val(n),Xe(-1!==s.indexOf("from")?"from":"to")},be=function(){var e=$(this),t=e.parent(),a=e.is(":checked"),s=t.data("id");a?"sort"===t.data("group")?(Re(".display",s,1),"d0"===s&&i.setDisplay(t.data("sort"),"sort")):"string"==typeof s&&-1!==s.indexOf("d")?(Re(".display",s,1),i.setDisplay("1","d1"===s?"desc":"showtags"),"d1"===s&&Ue()):(Re(".tag-group",s,1),i.setTag(s.toString(),"add")):"string"==typeof s&&-1!==s.indexOf("d")?(Re(".display",s,0),i.setDisplay("0","d1"===s?"desc":"showtags"),"d1"===s&&Ue()):(Re(".tag-group",s,0),i.setTag(s.toString(),"remove"))},Ce=function(){var e=R.find("option:selected").eq(0),t=R.siblings(".hidden").eq(0),a=e.val().toLowerCase();t.data("sort",a),i.setDisplay(a,"sort"),Ue()},we=function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target),a=R.siblings(".hidden").eq(0),s=t.data("sort");i.getDisplaySort()===s?"0"===i.getDisplayDesc()?(i.setDisplay("1","desc"),Re(".display","d1",1)):(i.setDisplay("0","desc"),Re(".display","d1",0)):i.setDisplay(s,"sort"),Ue()},xe=function(){var e=$(this),t=0;"searchquery"===e.data("group")?(V.find(".search-query").val(""),i.setText("")):"date-from"===e.data("group")?(j.datepicker("update",""),$("#date-from-eurodate").val(""),i.setDate("0","date-from")):"date-to"===e.data("group")?(E.datepicker("update",""),$("#date-to-eurodate").val(""),i.setDate("0","date-to")):"sort"===e.data("group")?(R.val("name"),i.setDisplay("name","sort"),Ue()):"display"===e.data("type")?(t=e.data("id"),N.find("label").filter('[data-id="'+t+'"]').find("input").prop("checked",!1),"d1"===t?(i.setDisplay("0","desc"),Ue()):"d2"===t&&i.setDisplay("0","showtags")):(t=e.data("id"),N.find("label").filter('[data-id="'+t+'"]').find("input").prop("checked",!1),i.setTag(t,"remove")),e.remove(),"sort"===e.data("group")||"course"===e.data("type")||e.data("type")},De=function(){var e=$(this),t=e.is(":checked"),a=null,s="",n="",o={};t?(s=e.data("group"),n=s,a=V.find('fieldset[data-group="'+n+'"]'),o=$.extend({},te,{id:e.data("id"),type:e.data("type"),group:e.data("group"),name:e.data("name")}),ie(a,o)):V.find('[data-id="'+e.data("id")+'"]').remove()},ke=function(e){var t=null,a="",s=null,n=null;t=$(e.currentTarget),a=t.val().toLowerCase(),s=K.find(".unlist"),n=s.find("label"),n.each(function(){var e=$(this);-1!==e.find("input").data("name").toLowerCase().indexOf(a)?e.parent("li").removeClass("hidden"):e.parent("li").addClass("hidden")}),""!==a?K.find(".accordion-body").each(function(){var e=$(this);e.has("li:not(.hidden)").length?e.collapse("show"):e.collapse("hide")}):K.find(".accordion-body").collapse("hide")},Oe=function(e){var t=$(this),a;e.preventDefault(),a=t.find(".search-query").val(),i.setText(a),Qe()},Se=function(){var e,t={};return e=V.find("label").has(":checked"),e.each(function(){var e=$(this);"course"===e.data("type")&&(t.hasOwnProperty(e.data("group"))||(t[e.data("group")]=[]),t[e.data("group")].push(e.data("group")+"-"+e.data("name")))}),t},Te=function(){var e,t=[];return e=V.find("label.checkbox"),e.each(function(){var e=$(this);"course"===e.data("type")&&t.push({id:e.data("id"),type:e.data("type"),name:e.data("name"),group:e.data("group"),groupid:e.data("groupid")})}),t},qe=function(){var e,t=[];return e=V.find("label").has(":checked"),e.each(function(){var e=$(this);"display"===e.data("type")&&("sort"===e.data("group")?t.push("sort-"+e.data("sort")):t.push(e.data("group")))}),t},Ie=function(){var e=null,t=null,a=qe(),s="name",n=null;if(!y.length){var o;for(o in m)m.hasOwnProperty(o)&&y.push({id:m[o].id,sortorder:m[o].sortorder,sortdate:m[o].sortdate,availnumber:m[o].availnumber,deadline:m[o].deadline,municipality:m[o].municipality?m[o].municipality.toLowerCase():"",location:m[o].location?m[o].location.toLowerCase():""})}var i=function(e,t){return u?t[se[s]]<e[se[s]]?1:-1:t[se[s]]>e[se[s]]?1:-1};-1!==a.indexOf("tags")?B.find(".course-list").removeClass("tags-hidden"):B.find(".course-list").addClass("tags-hidden"),u=-1===a.indexOf("sortdesc"),a.forEach(function(e){-1!==e.indexOf("sort-")&&(s=e.replace("sort-",""))}),B.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),B.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc"),n=B.find(".course-list-col-titles").find('[data-sort="'+s+'"]'),u?n.addClass("sortasc"):n.addClass("sortdesc"),y.sort(i),v=[],y.forEach(function(e){v.push("c"+e.id)}),Ee()},je=function(){var e=null,t=null,a=qe(),s="name",n=null,o=function(e,t){return u?$(t).data(se[s])<$(e).data(se[s])?1:-1:$(t).data(se[s])>$(e).data(se[s])?1:-1};-1!==a.indexOf("tags")?B.find(".course-list").removeClass("tags-hidden"):B.find(".course-list").addClass("tags-hidden"),u=-1===a.indexOf("sortdesc"),a.forEach(function(e){-1!==e.indexOf("sort-")&&(s=e.replace("sort-",""))}),B.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),B.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc"),n=B.find(".course-list-col-titles").find('[data-sort="'+s+'"]'),u?n.addClass("sortasc"):n.addClass("sortdesc"),e=B.find("#tabcards").find(".course-cards").eq(0),e.html(e.children(".course-card-item").sort(o)),e=B.find("#tablist").find(".course-list").find("tbody").eq(0),e.html(e.children(".course-list-item").sort(o)),t=B.find("#tablist").find(".course-list"),t.find("tr:not(.hide-item)").each(function(e){e%2?$(this).removeClass("odd"):$(this).addClass("odd")})},Ee=function(){return t.debug("enter filterCourses"),new Promise(function(e,t){var a=Se(),s=i.getText(),n=i.getFromDate(),o=0,r=i.getToDate(),d=0,c=""!==i.getText(),l=[],u,f,h=!1;if(_=v.slice(),!Object.keys(a).length&&!c&&"0"===n&&"0"===r)return void e(_);"0"===n&&"0"===r||(console.log(n,r),o=parseInt(n.replace(/-/g,""),10),d=parseInt(r.replace(/-/g,""),10),l=_.filter(function(e){if(u=m[e],f=parseInt(u.sortdate,10),o&&d){if(f>=o&&f<=d)return!0}else if(o){if(f>=o)return!0}else{if(!d)return!1;if(f<=d)return!0}}),l.length&&(h=!0,_=l.slice(),l=[])),c&&(l=_.filter(function(e){return u=m[e],u.hasOwnProperty("alltext")&&u.alltext&&-1!==u.alltext.indexOf(s)}),_=l.slice(),l.length?(h=!0,l=[]):h=!1),Object.keys(a).forEach(function(e){l=_.filter(function(t){var s=!1;return a[e].forEach(function(e){-1!==m[t].tagcollection.indexOf(e)&&(s=!0)}),s}),_=l.slice(),l.length?(h=!0,l=[]):h=!1}),h||(_=[-1]),e(_)})},Pe=function(e){return t.debug("enter sortFilteredCourses"),new Promise(function(t,a){t(o.chain(o.values(m)).filter(function(t){return-1!==e.indexOf("c"+t.id)}).orderBy(se[i.getDisplaySort()],"0"===i.getDisplayDesc()?"asc":"desc").flatMap(function(e){return"c"+e.id}).value())})},Me=function(e){return t.debug("enter showFilteredCourses"),new Promise(function(t,a){var n,o;W.html(""),z&&z.children("tbody").html(""),e.length&&-1!==e[0]?(O=e.slice(),S=e.slice(),h=e.length,g.text(h),n={courses:[]},"0"===i.getView()?(o=O.splice(0,12),n.courses=o.map(function(e){return m[e]}),n.courses.length&&s.render("local_course_search/course_search_course_card_set",n).done(function(e){W.html(e),ue(!0)})):"1"===i.getView()&&(o=S.splice(0,30),n.courses=o.map(function(e){return m[e]}),n.courses.length&&s.render("local_course_search/course_search_course_list_set",n).done(function(e){z.children("tbody").html(e),fe(!0)}))):(O=[],S=[],h=0,g.text(h)),t(e)})},Fe=function(e){var t=B.find(".course-cards"),a=B.find(".course-list");e.length?-1===e[0]?v.forEach(function(e){t.find("#coursecarditem-"+e).addClass("hide-item"),a.find("#courselistitem-"+e).addClass("hide-item")}):v.forEach(function(s){-1!==e.indexOf(s)?(t.find("#coursecarditem-"+s).removeClass("hide-item"),a.find("#courselistitem-"+s).removeClass("hide-item")):(t.find("#coursecarditem-"+s).addClass("hide-item"),a.find("#courselistitem-"+s).addClass("hide-item"))}):v.forEach(function(e){t.find("#coursecarditem-"+e).removeClass("hide-item"),a.find("#courselistitem-"+e).removeClass("hide-item")})},Je=function(){return t.debug("enter getCoursedata"),new Promise(function(e,t){if(!1)return void e(!1);$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:T,nocache:parseInt(c,10)}}])[0]).then(function(t){var a=JSON.parse(t.coursedata);m=a.courses,v=Object.keys(m),_=v.slice(),O=v.slice(),S=v.slice(),B.find(".alert-info").remove(),h=v.length,g.text(h),p.show(),console.log("courses",m),console.log("courseids",v.slice()),e(!0)})})},Ne=function(){$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:T}}])[0]).then(function(e){var t=JSON.parse(e.coursedata),a=[];s.render("local_course_search/course_search_course_list",{}),m=t.courses,v=Object.keys(m),O=v.slice(),S=v.slice(),h=v.length,g.text(h),p.show(),console.log("courses",m),console.log("courseids",v.slice()),a=O.splice(0,12),re({courses:a.map(function(e){return m[e]})}),Ae()})},Ve=function(){$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:T}}])[0]).then(function(e){var t=JSON.parse(e.coursedata),a={},s=[];m=t.courses,y=[],v=Object.keys(m),O=v.slice(),S=v.slice(),h=v.length,g.text(h),p.show(),console.log("changed courses",m),console.log("changed courseids",v.slice()),ue(!0),ge(12)})},Le=function(e){return t.debug("enter saveInterests"),new Promise(function(t,s){var n={sesskey:M.cfg.sesskey,tags:e};$.when(a.call([{methodname:"local_course_search_save_search_criteria",args:{data:JSON.stringify(n)}}])[0]).then(function(e){var a=JSON.parse(e.result);f=!f,W.html(""),z&&z.children("tbody").html(""),V.find(".tag-group").not(":has(label.checkbox)").addClass("fieldset-hidden"),B.toggleClass("section-hidden"),K.toggleClass("section-hidden"),t(!0)})})},Be=function(){$.when(a.call([{methodname:"local_course_search_get_user_search_criteria",args:{userid:T}}])[0]).then(function(e){var a=JSON.parse(e.data);t.debug("get_user_search_criteria")})},Ae=function(){Z||$.when(a.call([{methodname:"local_course_search_get_all_course_tags",args:{userid:T}}])[0]).then(function(e){var t=JSON.parse(e.data);le(t)})},He=function(){Te().forEach(function(e){K.find('[data-id="'+e.id+'"]').attr("checked",!0)})},We=function(e){require(["javascript/locales/bootstrap-datepicker.no","javascript/locales/bootstrap-datepicker.de"],function(){j.datepicker({language:e,format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){_e(e)}),E.datepicker({language:e,format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){_e(e)})})},$e=function(){var e=V.find(".display").find('[data-group="tags"]');G.find(".active").removeClass("active"),"0"===i.getView()?(t.debug("Show cards view"),e.addClass("hidden"),Ge(0),ze(1)):"1"===i.getView()&&(t.debug("Show list view"),e.removeClass("hidden"),ze(0),Ge(1))},ze=function(e){e?(G.find('a[href="#tabcards"]').parent("li").addClass("active"),A.addClass("active"),ue(!0)):(A.removeClass("active"),ue(!1))},Ge=function(e){e?(G.find('a[href="#tablist"]').parent("li").addClass("active"),H.addClass("active"),fe(!0)):(H.removeClass("active"),fe(!1))},Ke=function(e,t){""!==e&&U.find("li").has(e).remove(),o.isObject(t)&&s.render("local_course_search/course_search_selected_tags_item",t).done(function(e){X.append(e)})},Qe=function(){var e=i.getText(),t;""!==e&&(t=$.extend({},ae,{type:"course",group:"searchquery",name:e,pretext:M.str.local_course_search.searchtext})),Ke('[data-group="searchquery"]',t)},Re=function(e,t,a){var s=V.find(e).find('.checkbox[data-id="'+t+'"]'),n="",o=null;a?(s.find("input").prop("checked",!0),o=$.extend({},ae,{id:s.data("id"),type:s.data("type"),group:s.data("group"),name:s.data("name")}),"sort"===s.data("group")&&(o.sort=s.data("sort"),o.name=M.str.local_course_search.sortby+" "+M.str.local_friadmin[ne[o.sort]],n='[data-group="sort"]'),Ke(n,o)):(s.find("input").prop("checked",!1),Ke('[data-id="'+s.data("id")+'"]',o))},Ue=function(){var e;R.val(i.getDisplaySort()),R.siblings(".hidden").eq(0).data("sort",i.getDisplaySort()),B.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),B.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc");var t=B.find(".course-list-col-titles").find('[data-sort="'+i.getDisplaySort()+'"]');"0"===i.getDisplayDesc()?t.addClass("sortasc"):t.addClass("sortdesc"),e=$.extend({},ae,{id:"d0",type:"display",group:"sort",sort:i.getDisplaySort(),name:M.str.local_course_search.sortby+" "+M.str.local_friadmin[ne[i.getDisplaySort()]]}),Ke('[data-id="'+e.id+'"]',e)},Xe=function(e){var t="0",a="",s="",n=null;"from"===e?t=i.getFromDate():"to"===e&&(t=i.getToDate()),"0"!==t?("from"===e?(s=P.siblings('input[type="hidden"]').eq(0).val(),a=j.data("name")):"to"===e&&(s=F.siblings('input[type="hidden"]').eq(0).val(),a=E.data("name")),n=$.extend({},ae,{id:"date-"+e,type:"course",group:"date-"+e,name:a,posttext:" "+s}),Ke('[data-id="date-'+e+'"]',n)):Ke('[data-id="date-'+e+'"]',null)},Ye=function(){"1"===i.getDisplayShowtags()?B.find(".course-list").removeClass("tags-hidden"):B.find(".course-list").addClass("tags-hidden")},Ze=function(){Ee().then(Pe).then(Me)},et=function(){Je().then(function(e){e&&Ze()})},tt=function(){Je().then(function(e){Ae(),e&&Ze()})},at=function(e){Le(e).then(Je).then(function(e){e&&Ze()})},st=function(){var e,a=[];if($e(),""!==i.getText()){var s=i.getText();t.debug("Set search text to: "+s),L.val(s),Qe()}t.debug("Check tags: "),t.debug(i.getTags()),i.getTags().forEach(function(e){""!==e&&(V.find(".checkbox").filter('[data-id="'+e+'"]').length?Re(".tag-group",e,1):a.push(e))}),a.length&&i.removeTags(a),"0"!==i.getFromDate()&&o.delay(function(){j.datepicker("update",i.getFromDate().split("-").reverse().join(".")),Xe("from")},500),"0"!==i.getToDate()&&o.delay(function(){E.datepicker("update",i.getToDate().split("-").reverse().join(".")),Xe("to")},500),"1"===i.getDisplayDesc()&&Re(".display","d1",1),Ue(),"1"===i.getDisplayShowtags()&&Re(".display","d2",1),Ye()};return{init:function(e,a){t.debug("AMD module init with lang "+e),c=a,i.init(),g=$("#actualCourseCount"),p=$("#actualCourseCountInfo"),J=$("#catalog-area"),T=parseInt(J.data("userid"),10),V=$("#course-search-form"),L=V.find("#course-search"),N=$("#search-area"),Q=N.find(".form-search"),R=N.find("#select-sort"),P=$("#date-from"),j=P.parents('[data-group="date-from"]'),F=$("#date-to"),E=F.parents('[data-group="date-to"]'),Y=N.find("#switch-display"),B=$("#result-area"),G=B.find(".nav-tabs").eq(0),A=B.find("#tabcards"),H=B.find("#tablist"),W=B.find("#course-cards"),z=B.find("#course-list"),U=$("#tag-area"),X=U.find(".selected-tags"),K=$("#tag-preselect-area"),V.on("submit",Oe),N.on("change",'[type="checkbox"]',be),N.on("change","#select-sort",Ce),B.on("shown",'a[data-toggle="tab"]',ye),B.on("click","th.coltitle",we),U.on("click","button",xe),K.on("change",'[type="checkbox"]',De),K.on("keyup","#tagFilter",ke),Y.on("click",ve),q=new r(W.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("cardsInfScroll init")}}),I=new r(z.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){t.debug("listInfScroll init")}}),$("body").on("viewstate:change",function(e,a){t.debug("coursesearch:change",a),"view"===a||("showtags"===a?Ye():"sort"===a||"desc"===a?Pe(_).then(Me):Ze())}),We(e),st(),window.Promise?tt():require(["javascript/promise.min"],function(){tt()})}}}});