define(["jquery","core/notification","core/log","core/ajax","core/templates","theme_bootstrapbase/bootstrap","local_course_search/is_loader","local_course_search/dp_loader"],function($,e,t,a,n,o,r){"use strict";t.debug("AMD module loaded.");var s="name",i=!0,c=!1,l=0,d=null,u={},f=[],h=[],p=12,g=6,m=30,_=15,v=!1,y=!1,b=[],C=[],x=0,k=null,O=null,w=null,q=null,S=null,E=null,j=null,D=null,J=null,L=null,N=null,I=null,T=null,P=null,A=null,B=null,H=null,W=null,F=!1,z="hide-item",G={id:0,type:null,group:null,name:null},K={id:0,type:null,group:null,name:null,sort:null,pretext:null,posttext:null,remove:0},Q={name:"sortorder",date:"sortdate",availseats:"availnumber",deadline:"deadline",municipality:"municipality",location:"location"},R={name:"course_name",date:"course_date",availseats:"course_seats",deadline:"course_deadline",municipality:"course_municipality",location:"course_location"},U=function(e,t){n.render("local_course_search/course_search_region_search_groups_item",t).done(function(t){e.append(t)})},V=function(e){n.render("local_course_search/course_search_result_area",{}).done(function(t){j.html(t),D=j.find("#tabcards"),J=j.find("#tablist"),X(e)})},X=function(e){n.render("local_course_search/course_search_course_cards",e).done(function(e){D.html(e),L=j.find("#course-cards"),v=!0,k=new r(L.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){console.log("cardsInfScroll init")}}),Z(!0),I=$(".nav-tabs").eq(0),$('a[data-toggle="tab"]').on("shown",ce)})},Y=function(e){n.render("local_course_search/course_search_course_list",e).done(function(e){J.html(e),N=j.find("#course-list"),y=!0,O=new r(N.get(0),{path:"page{{#}}",loadOnScroll:!1,history:!1,onInit:function(){console.log("listInfScroll init")}}),ee(!0)})},Z=function(e){k&&(e?k.on("scrollThreshold",ne):k.off("scrollThreshold",ne))},ee=function(e){O&&(e?O.on("scrollThreshold",re):O.off("scrollThreshold",re))},te=function(e){},ae=function(e){n.render("local_course_search/course_search_tag_preselect_area",e).done(function(e){T.html(e),F=!0,Ne()})},ne=function(){if(!b.length)return console.log("card all shown"),void Z(!1);console.log("card more courses"),oe()},oe=function(e){var t=void 0===e?6:e,a={courses:[]},o=b.splice(0,t);a.courses=o.map(function(e){return u[e]}),a.courses.length&&n.render("local_course_search/course_search_course_card_set",a).done(function(e){L.append(e)})},re=function(){if(!C.length)return console.log("list all shown"),void ee(!1);console.log("list more courses"),se()},se=function(e){var t=void 0===e?15:e,a={courses:[]},o=C.splice(0,t);a.courses=o.map(function(e){return u[e]}),a.courses.length&&n.render("local_course_search/course_search_course_list_set",a).done(function(e){N.children("tbody").append(e)})},ie=function(){var e="",t=[],a=null,n,o;c?(W.text(W.data("changetoselection")),j.find('[href="#tablist"]').hasClass("active")&&S.find(".display").find('[data-group="tags"]').removeClass("hidden"),a=q.find(".tag-group"),n=a.length-1,a.length&&a.each(function(a){var r=$(this),s=null;s=r.find(".checkbox"),o=s.length-1,s.length&&s.each(function(a){e+=$(this).data("id"),t.push($(this).data("id")),a<o&&(e+=",")}),a<n&&(e+="|")}),E.blur(),B.find(".btn-tag").each(function(){$(this).click()}),De(t)):(c=!c,W.text(W.data("changetoresults")),S.find(".display").find('[data-group="tags"]').addClass("hidden"),Z(!1),ee(!1),E.blur(),B.find(".btn-tag").each(function(){$(this).click()}),S.find(".fieldset-hidden").removeClass("fieldset-hidden"),j.toggleClass("section-hidden"),T.toggleClass("section-hidden"))},ce=function(e){var t=$(e.target).attr("href"),a=S.find(".display").find('[data-group="tags"]'),n=a.find("input");if("#tabcards"===t)a.addClass("hidden"),ee(!1),Z(!0),L.children("li").length||oe(12);else if("#tablist"===t)if(a.removeClass("hidden"),Z(!1),ee(!0),y)N.children("tbody").children("tr").length||se(30);else{var o=C.splice(0,30);Y({courses:o.map(function(e){return u[e]})})}},le=function(e){var t=$(e.target),a=t.parents(".date"),o=e.format("yyyymmdd"),r=e.format("dd.mm.yyyy"),s=$.extend({},K,{type:a.data("type"),group:a.data("group"),name:a.data("name"),posttext:" "+r});t.siblings('input[type="hidden"]').eq(0).val(o),B.find("button").filter('[data-name="'+a.data("name")+'"]').parent("li").remove(),""===r?s.remove=1:n.render("local_course_search/course_search_selected_tags_item",s).done(function(e){H.append(e)}),we()},de=function(){var e=$(this),t=e.parent(),a=e.is(":checked"),o=null,r=$.extend({},K,{id:t.data("id"),type:t.data("type"),group:t.data("group"),name:t.data("name")});a?"sort"===t.data("group")?(o=B.find("button").filter('[data-group="sort"]').parent("li").remove(),r.sort=t.data("sort"),r.name=M.str.local_course_search.sortby+" "+M.str.local_friadmin[R[r.sort]],n.render("local_course_search/course_search_selected_tags_item",r).done(function(e){H.append(e)})):n.render("local_course_search/course_search_selected_tags_item",r).done(function(e){H.append(e)}):(o=B.find("button").filter('[data-name="'+e.parent().data("name")+'"]').parent("li").remove(),r.remove=1),"course"===t.data("type")&&we(),ke()},ue=function(){fe()},fe=function(){var e=A.find("option:selected").eq(0),t=A.siblings(".hidden").eq(0),a=e.val().toLowerCase();s!==a&&(s=a,t.data("sort",a),t.find("input").trigger("change"))},he=function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target),a=A.siblings(".hidden").eq(0),n=t.data("sort");s===n?(i=!i,q.find('[data-group="sortdesc"]').find("input").click()):s=n,A.val(n),a.data("sort",n),a.find("input").trigger("change")},pe=function(){var e=$(this);"searchquery"===e.data("group")?S.find(".search-query").val(""):"date-from"===e.data("group")?($("#date-from").datepicker("update",""),$("#date-from-eurodate").val("")):"date-to"===e.data("group")?($("#date-to").datepicker("update",""),$("#date-to-eurodate").val("")):"sort"===e.data("group")?A.val("name"):q.find("label").filter('[data-name="'+e.data("name")+'"]').find("input").prop("checked",!1),e.remove(),"sort"===e.data("group")?ue():"course"===e.data("type")?we():e.data("type")},ge=function(){var e=$(this),t=e.is(":checked"),a=null,n="",o="",r={};t?(n=e.data("group"),o=n,a=S.find('fieldset[data-group="'+o+'"]'),r=$.extend({},G,{id:e.data("id"),type:e.data("type"),group:e.data("group"),name:e.data("name")}),U(a,r)):S.find('[data-id="'+e.data("id")+'"]').remove()},me=function(e){var t=null,a="",n=null,o=null;t=$(e.currentTarget),a=t.val().toLowerCase(),n=T.find(".unlist"),o=n.find("label"),o.each(function(){var e=$(this);-1!==e.find("input").data("name").toLowerCase().indexOf(a)?e.parent("li").removeClass("hidden"):e.parent("li").addClass("hidden")}),""!==a?T.find(".accordion-body").each(function(){var e=$(this);e.has("li:not(.hidden)").length?e.collapse("show"):e.collapse("hide")}):T.find(".accordion-body").collapse("hide")},_e=function(e){var t=$(this),a,o;e.preventDefault(),a=t.find(".search-query").val(),o=$.extend({},K,{type:"course",group:"searchquery",name:a,pretext:"Search text: "}),B.find("li").has('[data-group="searchquery"]').remove(),""!==a&&n.render("local_course_search/course_search_selected_tags_item",o).done(function(e){H.append(e)}),we()},ve=function(){return E.val().toLowerCase()},ye=function(){var e,t={};return e=S.find("label").has(":checked"),e.each(function(){var e=$(this);"course"===e.data("type")&&(t.hasOwnProperty(e.data("group"))||(t[e.data("group")]=[]),t[e.data("group")].push(e.data("group")+"-"+e.data("name")))}),t},be=function(){var e,t=[];return e=S.find("label.checkbox"),e.each(function(){var e=$(this);"course"===e.data("type")&&t.push({id:e.data("id"),type:e.data("type"),name:e.data("name"),group:e.data("group"),groupid:e.data("groupid")})}),t},Ce=function(){var e={from:null,to:null},t;return t=$("#date-from-eurodate").val(),""!==t&&(e.from=t),t=$("#date-to-eurodate").val(),""!==t&&(e.to=t),e},xe=function(){var e,t=[];return e=S.find("label").has(":checked"),e.each(function(){var e=$(this);"display"===e.data("type")&&("sort"===e.data("group")?t.push("sort-"+e.data("sort")):t.push(e.data("group")))}),t},ke=function(){var e=null,t=null,a=xe(),n="name",o=null;if(!f.length){var r;for(r in u)u.hasOwnProperty(r)&&f.push({id:u[r].id,sortorder:u[r].sortorder,sortdate:u[r].sortdate,availnumber:u[r].availnumber,deadline:u[r].deadline,municipality:u[r].municipality?u[r].municipality.toLowerCase():"",location:u[r].location?u[r].location.toLowerCase():""})}var s=function(e,t){return i?t[Q[n]]<e[Q[n]]?1:-1:t[Q[n]]>e[Q[n]]?1:-1};-1!==a.indexOf("tags")?j.find(".course-list").removeClass("tags-hidden"):j.find(".course-list").addClass("tags-hidden"),i=-1===a.indexOf("sortdesc"),a.forEach(function(e){-1!==e.indexOf("sort-")&&(n=e.replace("sort-",""))}),j.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),j.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc"),o=j.find(".course-list-col-titles").find('[data-sort="'+n+'"]'),i?o.addClass("sortasc"):o.addClass("sortdesc"),f.sort(s),h=[],f.forEach(function(e){h.push("c"+e.id)}),we()},Oe=function(){var e=null,t=null,a=xe(),n="name",o=null,r=function(e,t){return i?$(t).data(Q[n])<$(e).data(Q[n])?1:-1:$(t).data(Q[n])>$(e).data(Q[n])?1:-1};-1!==a.indexOf("tags")?j.find(".course-list").removeClass("tags-hidden"):j.find(".course-list").addClass("tags-hidden"),i=-1===a.indexOf("sortdesc"),a.forEach(function(e){-1!==e.indexOf("sort-")&&(n=e.replace("sort-",""))}),j.find(".course-list-col-titles").find(".sortasc").removeClass("sortasc"),j.find(".course-list-col-titles").find(".sortdesc").removeClass("sortdesc"),o=j.find(".course-list-col-titles").find('[data-sort="'+n+'"]'),i?o.addClass("sortasc"):o.addClass("sortdesc"),e=j.find("#tabcards").find(".course-cards").eq(0),e.html(e.children(".course-card-item").sort(r)),e=j.find("#tablist").find(".course-list").find("tbody").eq(0),e.html(e.children(".course-list-item").sort(r)),t=j.find("#tablist").find(".course-list"),t.find("tr:not(.hide-item)").each(function(e){e%2?$(this).removeClass("odd"):$(this).addClass("odd")})},we=function(){var e=ye(),t=ve(),a=Ce(),n=""!==t,o=Me(h),r=[],s,i=!1;if(!Object.keys(e).length&&""===t&&null===a.from&&null===a.to)return void qe(o);null===a.from&&null===a.to||(r=o.filter(function(e){if(s=u[e],null!==a.from&&null!==a.to){if(s.sortdate>=a.from&&s.sortdate<=a.to)return!0}else if(null!==a.from){if(s.sortdate>=a.from)return!0}else{if(null===a.to)return!1;if(s.sortdate<=a.to)return!0}}),r.length&&(i=!0,o=Me(r),r=[])),n&&(r=o.filter(function(e){return s=u[e],s.hasOwnProperty("alltext")&&s.alltext&&-1!==s.alltext.indexOf(t)}),o=Me(r),r.length?(i=!0,r=[]):i=!1),Object.keys(e).forEach(function(t){r=o.filter(function(a){var n=!1;return e[t].forEach(function(e){-1!==u[a].tagcollection.indexOf(e)&&(n=!0)}),n}),o=Me(r),r.length?(i=!0,r=[]):i=!1}),i||(o=[-1]),qe(o)},qe=function(e){var t,a;L.html(""),N&&N.children("tbody").html(""),e.length&&-1!==e[0]?(b=Me(e),C=Me(e),l=e.length,d.text(l),t={courses:[]},D.hasClass("active")?(a=b.splice(0,12),t.courses=a.map(function(e){return u[e]}),t.courses.length&&n.render("local_course_search/course_search_course_card_set",t).done(function(e){L.html(e),Z(!0)})):J.hasClass("active")&&(a=C.splice(0,30),t.courses=a.map(function(e){return u[e]}),t.courses.length&&n.render("local_course_search/course_search_course_list_set",t).done(function(e){N.children("tbody").html(e),ee(!0)}))):(b=[],C=[],l=0,d.text(l))},Se=function(e){var t=j.find(".course-cards"),a=j.find(".course-list");e.length?-1===e[0]?h.forEach(function(e){t.find("#coursecarditem-"+e).addClass("hide-item"),a.find("#courselistitem-"+e).addClass("hide-item")}):h.forEach(function(n){-1!==e.indexOf(n)?(t.find("#coursecarditem-"+n).removeClass("hide-item"),a.find("#courselistitem-"+n).removeClass("hide-item")):(t.find("#coursecarditem-"+n).addClass("hide-item"),a.find("#courselistitem-"+n).addClass("hide-item"))}):h.forEach(function(e){t.find("#coursecarditem-"+e).removeClass("hide-item"),a.find("#courselistitem-"+e).removeClass("hide-item")})},Ee=function(){$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:x}}])[0]).then(function(e){var t=JSON.parse(e.coursedata),a=[];u=t.courses,h=Object.keys(u),b=h.slice(),C=h.slice(),l=h.length,d.text(l),console.log("courses",u),console.log("courseids",h.slice()),a=b.splice(0,12),V({courses:a.map(function(e){return u[e]})}),Le()})},je=function(){$.when(a.call([{methodname:"local_course_search_get_course_data",args:{userid:x}}])[0]).then(function(e){var t=JSON.parse(e.coursedata),a={},n=[];u=t.courses,f=[],h=Object.keys(u),b=h.slice(),C=h.slice(),l=h.length,d.text(l),console.log("changed courses",u),console.log("changed courseids",h.slice()),I.find('[href="#tabcards"]').trigger("click"),Z(!0),oe(12)})},De=function(e){var t={sesskey:M.cfg.sesskey,tags:e};$.when(a.call([{methodname:"local_course_search_save_search_criteria",args:{data:JSON.stringify(t)}}])[0]).then(function(e){var t=JSON.parse(e.result);c=!c,L.html(""),N&&N.children("tbody").html(""),je(),S.find(".tag-group").not(":has(label.checkbox)").addClass("fieldset-hidden"),j.toggleClass("section-hidden"),T.toggleClass("section-hidden")})},Je=function(){$.when(a.call([{methodname:"local_course_search_get_user_search_criteria",args:{userid:x}}])[0]).then(function(e){var a=JSON.parse(e.data);t.debug("get_user_search_criteria")})},Le=function(){F||$.when(a.call([{methodname:"local_course_search_get_all_course_tags",args:{userid:x}}])[0]).then(function(e){var t=JSON.parse(e.data);ae(t)})},Ne=function(){be().forEach(function(e){T.find('[data-id="'+e.id+'"]').attr("checked",!0)})},Ie=function(){$("#date-from").datepicker({format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){le(e)}),$("#date-to").datepicker({format:"dd.mm.yyyy",calendarWeeks:!0,todayHighlight:!0,clearBtn:!0,autoclose:!0}).on("changeDate",function(e){le(e)})},Me=function(e){return e.slice(0)};return{init:function(){t.debug("AMD module init."),d=$("#actualCourseCount"),w=$("#catalog-area"),x=parseInt(w.data("userid"),10),q=$("#search-area"),S=$("#course-search-form"),E=S.find("#course-search"),j=$("#result-area"),T=$("#tag-preselect-area"),B=$("#tag-area"),H=B.find(".selected-tags"),P=q.find(".form-search"),A=q.find("#select-sort"),W=q.find("#switch-display"),Ee(),q.on("change",'[type="checkbox"]',de),q.on("change","#select-sort",ue),j.on("click","th.coltitle",he),B.on("click","button",pe),T.on("change",'[type="checkbox"]',ge),T.on("keyup","#tagFilter",me),S.on("submit",_e),W.on("click",ie),Ie()}}});