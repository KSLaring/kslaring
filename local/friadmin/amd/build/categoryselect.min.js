define(["jquery","core/notification","core/log","core/ajax","core/templates","theme_bootstrapbase/bootstrap"],function($,e,t,a,l){"use strict";t.debug("AMD module categoryselect loaded.");var i=!0,s=[],o=$("#mform-mysettings-select"),n=$("#id_selcategory"),d=$("#friadmin-category-select-list-container"),c=$("#friadmin-category-select-list-edit"),r=function(e){var t=$(e.target),l=t.closest("li"),i=null;e.preventDefault(),t.hasClass("catname")?(i=n.find("option"),i.val(l.data("catid")),i.text(t.text()),d.find(".selected-item").removeClass("selected-item"),l.addClass("selected-item")):t.hasClass("tree-icon")&&(l.hasClass("not-loaded")?$.when(a.call([{methodname:"local_friadmin_get_subcategories",args:{catid:l.data("catid")}}])[0]).then(function(e){var t=JSON.parse(e.subcategorieshtml);if(""!==t){var a=l.find(".content");if(a.html(t),a.addClass("in"),l.siblings("li").not(".collapsed").addClass("collapsed").find(".in").removeClass("in"),l.removeClass("collapsed not-loaded").find(".collapse").addClass("in"),s.length){var i=s.shift();d.find('[data-catid="'+i+'"]').find(".tree-icon").trigger("click")}else{var o=n.val(),c=d.find('[data-catid="'+o+'"]');c.length&&c.addClass("selected-item")}}}):l.hasClass("collapsed")?(l.siblings("li").not(".collapsed").addClass("collapsed").find(".in").removeClass("in"),l.removeClass("collapsed").find(".collapse").eq(0).addClass("in")):(l.addClass("collapsed").find(".collapse").removeClass("in"),l.find("li").addClass("collapsed")))},f=function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target);if(i&&(i=!1,s=t.find("option").data("selcatpath").substr(1).split("/"),t.find("option").removeData("selcatpath"),s.pop(),s.length)){var a=s.shift();d.find('[data-catid="'+a+'"]').find(".tree-icon").trigger("click")}d.trigger("focus").collapse("toggle"),t.trigger("blur"),console.log("blur")},p=function(e){if(e.preventDefault(),i&&(i=!1,s=n.find("option").data("selcatpath").substr(1).split("/"),n.find("option").removeData("selcatpath"),s.pop(),s.length)){var t=s.shift();d.find('[data-catid="'+t+'"]').find(".tree-icon").trigger("click")}d.collapse("toggle")};return{init:function(){t.debug("AMD module categoryselect init."),o.on("click",".catname, .tree-icon.with-children",r),n.on("focus",f),c.on("click",p)}}});