define(["jquery","core/notification","core/log","core/ajax","core/templates","theme_bootstrapbase/bootstrap"],function($,e,a,t,l){"use strict";a.debug("AMD module categoryselect loaded.");var s=!0,i=[],o=$("#mform-mysettings-select"),n=$("#id_selcategory"),c=$("#friadmin-category-select-list-container"),d=function(e){var a=$(e.target),l=a.closest("li"),s=null;e.preventDefault(),a.hasClass("catname")?(s=n.find("option"),s.val(l.data("catid")),s.text(a.text())):a.hasClass("tree-icon")&&(l.hasClass("not-loaded")?$.when(t.call([{methodname:"local_friadmin_get_subcategories",args:{catid:l.data("catid")}}])[0]).then(function(e){var a=JSON.parse(e.subcategorieshtml);if(""!==a){var t=l.find(".content");if(t.html(a),t.addClass("in"),l.siblings("li").not(".collapsed").addClass("collapsed").find(".in").removeClass("in"),l.removeClass("collapsed not-loaded").find(".collapse").addClass("in"),i.length){var s=i.shift();c.find('[data-catid="'+s+'"]').find(".tree-icon").trigger("click")}}}):l.hasClass("collapsed")?(l.siblings("li").not(".collapsed").addClass("collapsed").find(".in").removeClass("in"),l.removeClass("collapsed").find(".collapse").eq(0).addClass("in")):(l.addClass("collapsed").find(".collapse").removeClass("in"),l.find("li").addClass("collapsed")))},r=function(e){e.preventDefault(),e.stopPropagation();var a=$(e.target);if(s&&(s=!1,i=a.find("option").data("selcatpath").substr(1).split("/"),a.find("option").removeData("selcatpath"),i.pop(),i.length)){var t=i.shift();c.find('[data-catid="'+t+'"]').find(".tree-icon").trigger("click")}a.trigger("blur"),c.trigger("focus").collapse("toggle")};return{init:function(){a.debug("AMD module categoryselect init."),o.on("click",".catname, .tree-icon.with-children",d),n.on("click select",r)}}});